<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOP Hub</title>
  <style>
    :root {
      --fg: #0b1220;
      --bg: #f7f9fc;
      --muted: #60708a;
      --card: #ffffff;
      --line: #e4e8f0;
      --accent: #2563eb;
      --accent-weak: #eef3ff;
      --ok: #16a34a;
      --warn: #dc2626;
      --shadow: 0 2px 10px rgba(16, 24, 40, .06), 0 1px 3px rgba(16, 24, 40, .06);
      --radius: 16px;
      --surface: #ffffff;
      --text: #0f172a;
      --line: #cfd6dd;
      --input-bg: #f6f8fa;
      --hl-bg: #F7B733;
      --hl-fg: #0f172a;
      --content-w: 1120px
    }

    [data-theme=dark] {
      --fg: #e5ecff;
      --bg: #020617;
      --muted: #9ca3af;
      --card: #020617;
      --surface: #020617;
      --line: #111827;
      --input-bg: #020617;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.5 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(6px);
      background: rgba(2, 6, 23, .96);
      border-bottom: 1px solid rgba(148, 163, 184, .3)
    }

    .shell {
      width: min(100%, var(--content-w));
      margin: 0 auto;
      padding: 10px 18px 16px
    }

    h1 {
      font-size: 18px;
      font-weight: 650;
      margin: 0;
      letter-spacing: 0;
      display: flex;
      align-items: center;
      gap: 10px
    }

    h1 span.label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted)
    }

    h1 span.badge {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, .15);
      color: #bfdbfe;
      border: 1px solid rgba(129, 140, 248, .4)
    }

    header .toprow {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px
    }

    header .right {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 11px
    }

    header .right strong {
      color: var(--fg);
      font-weight: 500
    }

    main {
      padding: 10px 16px 40px
    }

    main .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: center;
      margin-bottom: 10px
    }

    label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      display: block;
      margin-bottom: 4px
    }

    input[type=file],
    input[type=text],
    select {
      font: inherit;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .7);
      background: rgba(15, 23, 42, .9);
      color: var(--fg);
      outline: none;
      min-width: 0;
      box-shadow: 0 0 0 1px transparent;
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease
    }

    input[type=file] {
      padding: 5px 9px;
      max-width: 260px
    }

    input[type=text]:focus,
    select:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, .4)
    }

    input::placeholder {
      color: rgba(148, 163, 184, .9)
    }

    button {
      font: inherit;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .7);
      background: rgba(15, 23, 42, .9);
      color: var(--fg);
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      box-shadow: 0 1px 1px rgba(15, 23, 42, .7);
      transition: background .12s ease, border-color .12s ease, box-shadow .12s ease, transform .05s ease
    }

    button:hover {
      background: rgba(30, 64, 175, .95);
      border-color: #60a5fa;
      box-shadow: 0 2px 8px rgba(15, 23, 42, .9);
      transform: translateY(-.5px)
    }

    button:active {
      transform: translateY(.5px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0)
    }

    button.secondary {
      background: rgba(15, 23, 42, .85)
    }

    button.secondary:hover {
      background: rgba(15, 23, 42, 1)
    }

    button .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4ade80;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, .7)
    }

    .view-toggle {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px;
      border: 1px solid rgba(148, 163, 184, .7);
      background: rgba(15, 23, 42, .9);
      box-shadow: 0 1px 1px rgba(15, 23, 42, .8)
    }

    .view-toggle button {
      border-radius: 999px;
      border: none;
      box-shadow: none;
      padding: 3px 10px;
      font-size: 11px;
      color: var(--muted);
      background: transparent
    }

    .view-toggle button.active {
      background: rgba(30, 64, 175, .92);
      color: #e5ecff;
      box-shadow: 0 1px 4px rgba(15, 23, 42, .9)
    }

    .view-toggle button:hover {
      background: rgba(15, 23, 42, 1);
      color: #e5ecff
    }

    .view-toggle button.active:hover {
      background: rgba(30, 64, 175, .92)
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .7);
      background: rgba(15, 23, 42, .85);
      font-size: 11px;
      color: var(--muted)
    }

    .pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #F7B733, #f97316);
      box-shadow: 0 0 0 1px rgba(251, 146, 60, .7)
    }

    .pill strong {
      font-weight: 500;
      color: var(--fg)
    }

    .muted {
      color: var(--muted)
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .card,
    .rowitem {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow)
    }

    .card:hover,
    .rowitem:hover {
      outline: 3px solid var(--line)
    }

    .card h3,
    .rowitem h3 {
      margin: 0 0 6px;
      font-size: 15px;
      font-weight: 600
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px
    }

    .empty {
      padding: 32px 16px;
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, .8);
      background: rgba(15, 23, 42, .75);
      margin-top: 14px;
      text-align: center;
      color: var(--muted)
    }

    .empty strong {
      color: var(--fg)
    }

    .empty div {
      margin-top: 4px
    }

    .empty-drop {
      border-radius: 999px;
      padding: 6px 9px 7px;
      border: 1px dashed rgba(148, 163, 184, .8);
      background: rgba(15, 23, 42, .88);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 12px
    }

    .empty-drop .icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .8);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: rgba(148, 163, 184, 1)
    }

    .empty-drop strong {
      font-weight: 500;
      color: var(--fg)
    }

    .drop-target {
      border-radius: 16px;
      border: 1px dashed rgba(37, 99, 235, .7);
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 12px;
      color: rgba(129, 140, 248, 1);
      background: rgba(15, 23, 42, .9);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px
    }

    .drop-target.hidden {
      display: none
    }

    .drop-target .kbd {
      border-radius: 6px;
      padding: 2px 5px;
      border: 1px solid rgba(148, 163, 184, .8);
      font-size: 11px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
    }

    .link {
      color: #93c5fd;
      text-decoration: none;
      border-bottom: 1px solid rgba(147, 197, 253, .4);
      padding-bottom: 1px
    }

    .link:hover {
      color: #bfdbfe;
      border-bottom-color: rgba(191, 219, 254, .8)
    }

    .hidden {
      display: none !important
    }

    @media (max-width: 768px) {
      header .toprow {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px
      }

      main .row {
        flex-direction: column;
        align-items: stretch
      }

      input[type=file] {
        width: 100%
      }

      .view-toggle {
        width: 100%
      }

      .view-toggle button {
        flex: 1 0 0
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="shell">
      <div class="toprow">
        <div>
          <h1>
            <span class="label">HOFS · SOP Hub</span>
            SOP Library
            <span class="badge">
              <span class="dot"></span>
              Internal Prototype
            </span>
          </h1>
        </div>
        <div class="right">
          <span>Mode: <strong>Viewer-only</strong></span>
          <span>Source: <strong>CSV + SOP JSON</strong></span>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="file"><strong>CSV file</strong></label>
          <input id="file" type="file" accept=".csv" />
        </div>
        <div>
          <label for="search"><strong>Search</strong></label>
          <input id="search" type="text" placeholder="Search title or group…" />
        </div>
        <div>
          <label for="groupBy"><strong>Group</strong></label>
          <select id="groupBy">
            <option value="">No grouping</option>
            <option value="group">Group by Group</option>
          </select>
        </div>
        <div>
          <label><strong>Layout</strong></label>
          <div class="view-toggle" role="tablist" aria-label="Layout">
            <button id="btnCards" class="active" aria-pressed="true" aria-label="Cards view">Cards</button>
            <button id="btnRows" aria-pressed="false" aria-label="Rows view">Rows</button>
          </div>
        </div>
        <div>
          <label><strong>Sample</strong></label>
          <a id="dlSample" download="sop-hub-sample.csv">
            <button type="button" class="secondary" title="Download sample CSV">
              <span class="dot"></span>
              Sample CSV
            </button>
          </a>
        </div>
        <div>
          <label><strong>Actions</strong></label>
          <button id="btnClear" title="Clear loaded data">Clear</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="shell">
      <div id="empty" class="empty">
        <strong>No SOPs loaded yet</strong>
        <div>Drop a CSV file here or use the file picker above.</div>
        <div class="empty-drop">
          <span class="icon">⤓</span>
          <span>Try with the <strong>Sample CSV</strong> first to see the layout.</span>
        </div>
      </div>

      <div id="drop" class="drop-target hidden">
        <span>Drop CSV file here</span>
        <span class="kbd">CSV</span>
      </div>

      <div id="viewCards" class="grid" aria-live="polite"></div>
      <div id="viewRows" class="list hidden" aria-live="polite"></div>
    </section>

    <!--
    Expected CSV headers (order can vary):
    group,url

    Example rows:
    "Home Ownership","system-1.html"
    "Medical","system-2.html"
    -->
  </main>

  <script>
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => [...p.querySelectorAll(s)];

    const state = { items: [], layout: localStorage.getItem('sopHubLayout') || 'cards' };

    const fileInput = $('#file');
    const searchInput = $('#search');
    const groupBy = $('#groupBy');
    const viewCards = $('#viewCards');
    const viewRows = $('#viewRows');
    const empty = $('#empty');
    const drop = $('#drop');
    const btnCards = $('#btnCards');
    const btnRows = $('#btnRows');

    function normalizeHeader(h) {
      return String(h || '').trim().toLowerCase().replace(/\s+/g, '');
    }

    function parseCSV(text) {
      const rows = [];
      let cur = [];
      let field = '';
      let inQuotes = false;

      const pushField = () => {
        cur.push(field);
        field = '';
      };

      const pushRow = () => {
        if (cur.length || field) {
          cur.push(field);
          rows.push(cur);
          cur = [];
          field = '';
        }
      };

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (inQuotes) {
          if (ch === '"') {
            if (text[i + 1] === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += ch;
          }
        } else {
          if (ch === '"') {
            inQuotes = true;
          } else if (ch === ',') {
            pushField();
          } else if (ch === '\n' || ch === '\r') {
            if (ch === '\r' && text[i + 1] === '\n') i++;
            pushRow();
          } else {
            field += ch;
          }
        }
      }
      pushRow();
      return rows.filter(r => r.length && r.some(c => String(c).trim() !== ''));
    }

    function rowsToObjects(rows) {
      const header = rows[0].map(normalizeHeader);
      const idx = (k) => header.indexOf(normalizeHeader(k));
      const has = (k) => idx(k) !== -1;

      // Only url is required
      if (!has('url')) {
        throw new Error('Missing required column: url');
      }

      return rows.slice(1).map(r => {
        const url = r[idx('url')] || '';
        if (!url) return null;

        const group = has('group') ? (r[idx('group')] || '') : '';

        return {
          // title will be filled from embedded SOP JSON, not from the CSV
          title: '',
          url,
          group
        };
      }).filter(Boolean);
    }

    async function loadCSV(text) {
      try {
        const rows = parseCSV(text);
        const items = rowsToObjects(rows);
        // sort stable by group then title (will be nice after titles are hydrated)
        items.sort((a, b) => (a.group || '').localeCompare(b.group || '') || (a.title || '').localeCompare(b.title || ''));
        state.items = items;
        render();              // first render, maybe with URL as title
        await hydrateTitlesFromSop(); // then hydrate titles from embedded SOP JSON
      } catch (e) {
        alert('CSV error: ' + e.message);
      }
    }

    async function hydrateTitlesFromSop() {
      const items = state.items;
      if (!items || !items.length) return;

      for (const it of items) {
        if (!it.url || it._titleHydrated) continue;
        try {
          const res = await fetch(it.url);
          if (!res.ok) continue;

          const html = await res.text();

          // Extract <script id="jsonEmbedded" type="application/json">...</script>
          const match = html.match(/<script[^>]+id=["']jsonEmbedded["'][^>]*>([\s\S]*?)<\/script>/i);
          if (!match) continue;

          const jsonText = match[1].trim();
          const sop = JSON.parse(jsonText);

          const newTitle =
            (sop && typeof sop.title === 'string' && sop.title.trim()) ||
            (Array.isArray(sop.starters) &&
              sop.starters[0] &&
              typeof sop.starters[0].label === 'string' &&
              sop.starters[0].label.trim()) ||
            '';

          if (newTitle) {
            it.title = newTitle;
            it._titleHydrated = true;
          }
        } catch (err) {
          console.warn('Failed to hydrate title for', it.url, err);
        }
      }

      render();
    }

    // Sample CSV download
    const sample = `group,url
"Home Ownership","system-1.html"
"Medical","system-2.html"
`;
    const dl = $('#dlSample');
    dl.href = URL.createObjectURL(new Blob([sample], { type: 'text/csv' }));

    // Layout toggle
    function setLayout(mode) {
      state.layout = mode;
      localStorage.setItem('sopHubLayout', mode);
      btnCards.classList.toggle('active', mode === 'cards');
      btnCards.setAttribute('aria-pressed', mode === 'cards');
      btnRows.classList.toggle('active', mode === 'rows');
      btnRows.setAttribute('aria-pressed', mode === 'rows');
      viewCards.classList.toggle('hidden', mode !== 'cards');
      viewRows.classList.toggle('hidden', mode !== 'rows');
      render();
    }
    btnCards.onclick = () => setLayout('cards');
    btnRows.onclick = () => setLayout('rows');

    function match(q, hay) {
      return hay.includes(q);
    }

    function render() {
      const q = (searchInput.value || '').trim().toLowerCase();
      const gb = groupBy.value || '';
      const items = state.items.filter(it => {
        if (!q) return true;
        const hay = [it.title || it.url, it.group].join(' \n ').toLowerCase();
        return match(q, hay);
      });
      empty.classList.toggle('hidden', items.length !== 0);

      // grouping
      let groups = { '': items };
      if (gb) {
        groups = {};
        for (const it of items) {
          const key = (it[gb] || 'Unspecified');
          (groups[key] ||= []).push(it);
        }
      }

      // wipe views
      viewCards.innerHTML = '';
      viewRows.innerHTML = '';

      const renderCard = (it) => {
        const el = document.createElement('article'); el.className = 'card';
        el.innerHTML = `<h3>${escapeHTML(it.title || it.url)}</h3>
          <div class="muted">${escapeHTML(it.group || '')}</div>
          <p style="margin:10px 0 0"><a class="link" href="${it.url}" target="_blank" rel="noopener">Open SOP</a></p>`;
        return el;
      };

      const renderRow = (it) => {
        const el = document.createElement('article'); el.className = 'rowitem';
        el.innerHTML = `<h3>${escapeHTML(it.title || it.url)}</h3>
          <div class="muted">${escapeHTML(it.group || '')}</div>
          <p style="margin:6px 0 0"><a class="link" href="${it.url}" target="_blank" rel="noopener">Open SOP</a></p>`;
        return el;
      };

      const addHeader = (name, parent) => {
        const h = document.createElement('h2');
        h.textContent = name || 'Unspecified';
        h.style.cssText = 'margin:14px 2px 6px; font-size:14px; color:var(--muted)';
        parent.appendChild(h);
      };

      const inCards = state.layout === 'cards';
      const target = inCards ? viewCards : viewRows;
      for (const [gname, arr] of Object.entries(groups)) {
        if (gb) { addHeader(gname, target); }
        for (const it of arr) {
          target.appendChild(inCards ? renderCard(it) : renderRow(it));
        }
      }
    }

    function escapeHTML(str) {
      if (str == null) return '';
      return String(str).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c] || c));
    }

    // Drag & drop
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
      window.addEventListener(ev, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(ev => {
      window.addEventListener(ev, () => drop.classList.remove('hidden'), false);
    });

    ['dragleave', 'drop'].forEach(ev => {
      window.addEventListener(ev, () => drop.classList.add('hidden'), false);
    });

    window.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      if (!dt || !dt.files || !dt.files.length) return;
      const file = dt.files[0];
      readFile(file);
    });

    function readFile(file) {
      const r = new FileReader();
      r.onload = () => loadCSV(String(r.result || ''));
      r.readAsText(file);
    }

    // Clear data
    $('#btnClear').onclick = () => {
      state.items = [];
      render();
    };

    // File input
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) readFile(file);
    });

    // Search + grouping handlers
    searchInput.addEventListener('input', render);
    groupBy.addEventListener('change', render);

    // init
    setLayout(state.layout);
    render();
  </script>
</body>

</html>
