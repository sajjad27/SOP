<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOP Hub</title>
  <style>
    :root {
      --fg: #0b1220;
      --bg: #f7f9fc;
      --muted: #60708a;
      --card: #ffffff;
      --line: #e4e8f0;
      --accent: #2563eb;
      --accent-weak: #eef3ff;
      --ok: #16a34a;
      --warn: #dc2626;
      --shadow: 0 2px 10px rgba(16, 24, 40, .06), 0 1px 3px rgba(16, 24, 40, .06);
      --radius: 16px;
      --surface: #ffffff;
      --text: #0f172a;
      --line: #cfd6dd;
      --input-bg: #f6f8fa;
      --hl-bg: #F7B733;
      --hl-fg: #0f172a;
      --content-w: 1240px;
      --gutter: 16px;
      --skeleton-base: rgba(148, 163, 184, 0.16);
      --skeleton-highlight: rgba(148, 163, 184, 0.45);

    }

    html[data-theme="dark"] {
      --fg: #e5e7eb;
      --bg: #0b1220;
      --muted: #9aa4b2;
      --card: #0f172a;
      --line: #334155;
      /* was #233044: too low-contrast */
      --accent: #3b82f6;
      --accent-weak: rgba(59, 130, 246, .16);
      --ok: #22c55e;
      --warn: #ef4444;
      --shadow: none;
      --surface: #0f172a;
      --text: #e5ecf4;
      --input-bg: rgba(255, 255, 255, .06);
      --hl-bg: #F7B733;
      --hl-fg: #0f172a;
      --content-w: 1240px;
      --gutter: 16px;
      --skeleton-base: rgba(15, 23, 42, 0.9);
      --skeleton-highlight: rgba(148, 163, 184, 0.35);
    }

    /* @media (max-width:1439px) {
      :root {
        --content-w: 96vw;
        --gutter: 12px
      }
    }

    @media (min-width:1600px) {
      :root {
        --content-w: 1320px;
        --gutter: 24px
      }
    }

    @media (min-width:1920px) {
      :root {
        --content-w: 1440px;
        --gutter: 28px
      }
    } */

    @media (max-width: 1439px) {

      :root,
      html[data-theme="dark"] {
        --content-w: 96vw;
        /* fill more of the screen */
        --gutter: 12px;
      }
    }

    /* ≥ 1600px */
    @media (min-width: 1600px) {

      :root,
      html[data-theme="dark"] {
        --content-w: 1320px;
        --gutter: 24px;
      }
    }

    /* ≥ 1920px */
    @media (min-width: 1920px) {

      :root,
      html[data-theme="dark"] {
        --content-w: 1440px;
        --gutter: 28px;
      }
    }

    /* ≥ 2560px (27–30") */
    @media (min-width: 2560px) {

      :root,
      html[data-theme="dark"] {
        --content-w: 1560px;
        --gutter: 36px;
      }
    }

    /* optional 4K+ */
    @media (min-width: 3200px) {

      :root,
      html[data-theme="dark"] {
        --content-w: 1680px;
        --gutter: 40px;
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial
    }

    /* header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(6px);
      background: rgba(247, 249, 252, .85);
      border-bottom: 1px solid var(--line);
    } */

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(6px);
      background: rgba(247, 249, 252, .85);
      border-bottom: 1px solid var(--line);
    }

    .wrap {
      width: min(100%, var(--content-w));
      margin-inline: auto;
      padding: 10px var(--gutter)
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .grow {
      flex: 1
    }

    /* .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 4px 8px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: var(--card);
      color: var(--muted);
      font-size: 12px
    } */

    /* .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--muted);
      margin-top: 10px;
    }

    .pill strong {
      color: var(--fg);
    } */



    /* button,
    .btn,
    select,
    input[type="text"] {
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--fg);
      border-radius: 10px;
      padding: 8px 10px;
      font: inherit
    } */

    .starter-dual {
      display: contents;
    }

    .settings-overlay {
      position: fixed;
      inset: 0;
      z-index: 9998;
      background: transparent;

    }

    .settings-panel {
      position: absolute;
      z-index: 9999;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: var(--shadow);
      width: 175px;

      max-width: 92vw;

      min-width: 0;
      padding: 6px;
    }


    .settings-panel .settings-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
    }

    .settings-panel .settings-item .var-id {
      flex: 1 1 auto;
      min-width: 0;

      overflow-wrap: anywhere;

      word-break: break-word;

    }

    .settings-panel .settings-item .var-type {
      flex: 0 0 auto;
      white-space: nowrap;

      opacity: .7;
    }

    .settings-item {
      width: 100%;
      text-align: left;
      border: 0;
      background: transparent;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .settings-item:hover {
      background: var(--input-bg);
    }

    button,
    .btn {
      border: 1px solid var(--line);
      background: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    html[data-theme="dark"] header {
      background: rgba(10, 14, 22, .85);
      border-bottom-color: var(--line);
    }

    button,
    .btn,
    select,
    input[type="text"],
    textarea,
    input[type="number"],
    .panel,
    .item,
    .graph-svg,
    .table th,
    .table td {
      background: var(--card);
      color: var(--fg);
      border-color: var(--line);
    }

    button:active {
      transform: translateY(1px)
    }

    .btn-accent {
      background: var(--accent);
      border-color: transparent;
      color: #fff
    }

    .seg {
      display: inline-flex;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden
    }

    .seg button {
      background: transparent;
      border: 0;
      padding: 8px 12px
    }

    .seg .active {
      background: var(--accent);
      color: #fff
    }

    main {
      /* width: min(100%, var(--content-w));
      margin: 16px auto 60px;
      padding: 0 var(--gutter) 24px */
      margin: 0px auto 60px;
      padding-block-end: 24px;
      background: radial-gradient(120% 160% at 0% 0%,
          color-mix(in srgb, var(--accent-weak) 70%, transparent) 0, transparent 60%), radial-gradient(110% 140% at 100% 0%,
          color-mix(in srgb, var(--accent) 18%, transparent) 0, transparent 55%), linear-gradient(to bottom,
          color-mix(in srgb, var(--surface) 85%, var(--bg) 15%), var(--bg));
    }


    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(510px, 1fr));
      gap: 12px
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    /* .card,
    .rowitem {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow)
    }

    .card:hover,
    .rowitem:hover {
      outline: 3px solid var(--line)
    }

    .card h3,
    .rowitem h3 {
      margin: 0 0 4px;
      font-size: 16px
    } */

    .muted {
      color: var(--muted);
      font-size: 12px
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px
    }

    .link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--accent);
      text-decoration: none
    }

    .link::after {
      content: "↗"
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    #searchWrapper {
      display: flex;
      justify-content: end;
      margin-top: 16px;
    }

    #searchInput {
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--card);
      color: var(--fg);
      font: inherit;
      width: min(100%, 50vw);
      outline: none;

    }


    #searchInput:focus-visible {
      box-shadow: 0 0 0 1px var(--accent-weak);
      border-color: var(--accent);
    }

    #globalSearchSection {
      margin-top: 24px;
    }

    /* status text: “Searching…”, “Found N…”, etc. */
    #globalSearchStatus {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    /* results grid – same pattern as your .grid in Studio */
    #globalSearchResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }

    /* hide results block completely when needed */
    #globalSearchResults.hidden {
      display: none;
    }




    input::placeholder,
    textarea::placeholder {
      color: var(--muted);
      opacity: 1;
    }


    .hidden {
      display: none !important
    }

    .empty {
      color: var(--muted);
      text-align: center;
      padding: 40px 0;
      border: 1px dashed var(--line);
      border-radius: 12px
    }

    /* drop zone */
    .dz {
      border: 1.5px dashed var(--line);
      border-radius: 12px;
      padding: 8px 10px;
      color: var(--muted)
    }

    .dz.drag {
      background: var(--accent-weak);
      border-color: var(--accent)
    }

    /* .skeleton {
      position: relative;
      overflow: hidden;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 6px;
    }

    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg,
          transparent,
          rgba(148, 163, 184, 0.45),
          transparent);
      transform: translateX(-100%);
      animation: skeleton-shimmer 1.2s ease-in-out infinite;
    }

    .skeleton-title {
      height: 16px;
      margin: 2px 0 8px;
      width: 70%;
    }

    .skeleton-line {
      height: 10px;
      margin: 4px 0;
      width: 90%;
    }

    .skeleton-line-short {
      width: 55%;
    } */

    .skeleton {
      position: relative;
      overflow: hidden;
      background: var(--skeleton-base);
      border-radius: 6px;
    }

    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg,
          transparent,
          var(--skeleton-highlight),
          transparent);
      transform: translateX(-100%);
      animation: skeleton-shimmer 1.2s ease-in-out infinite;
    }

    .skeleton-title {
      height: 16px;
      margin: 2px 0 8px;
      width: 70%;
    }

    .skeleton-line {
      height: 10px;
      margin: 4px 0;
      width: 90%;
    }

    .skeleton-line-short {
      width: 55%;
    }


    @keyframes skeleton-shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .loading-inline {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: #60a5fa;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .card,
    .rowitem {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      text-align: left;
      background: var(--card);

      outline: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      min-height: 120px;
      box-shadow: var(--shadow);

      /* spotlight state */
      --spot-x: 50%;
      --spot-y: 50%;
      --spot-opacity: 0;

      transition:
        transform 220ms ease,
        box-shadow 260ms ease,
        border-color 260ms ease,
        outline-color 260ms ease,
        outline-width 260ms ease;
    }

    /* spotlight overlay (always exists, only opacity changes) */
    .card::before,
    .rowitem::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      background:
        radial-gradient(circle at var(--spot-x) var(--spot-y),
          color-mix(in srgb, var(--accent) 18%, transparent),
          transparent 70%);
      opacity: var(--spot-opacity);
      transition: opacity 320ms ease;
    }

    .card:hover,
    .card:focus-visible,
    .rowitem:hover,
    .rowitem:focus-visible {
      /* softer yellow outline: mix with white */
      /* outline: 3px solid color-mix(in srgb, var(--accent) 50%, var(--line)); */
      outline: 1px solid var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.20);
    }

    .card h3,
    .rowitem h3 {
      margin: 0 0 6px;
      font-size: 18px;
    }

    .card p,
    .rowitem p {
      margin: 0;
      color: var(--muted);
    }

    p.search-place {
      color: var(--hl-bg);
      text-align: right;
      font-style: italic;
    }

    .group-heading {
      grid-column: 1 / -1;
      margin: 20px 0 4px;
      font-size: 1.2rem;
      color: var(--muted)
        /* span whole row */
    }

    .card__actions {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-top: 10px;
    }



    /* Smooth theme toggle (light ↔ dark) */
    html,
    body,
    header {
      transition:
        background-color 260ms ease,
        color 260ms ease,
        border-color 260ms ease;
    }

    button,
    .btn,
    select,
    input[type="text"],
    input[type="number"],
    textarea,
    .rowitem,
    .panel,
    .item,
    .dz,
    .settings-panel,
    .skeleton {
      transition:
        background-color 260ms ease,
        color 260ms ease,
        border-color 260ms ease,
        box-shadow 260ms ease;
    }
  </style>

  <link rel="icon" type="image/svg+xml" href='
data:image/svg+xml;utf8,
<svg 
version="1.1" xmlns="http://www.w3.org/2000/svg" width="512" height="512"><path d="M0 0 C1.33241226 -0.01007584 1.33241226 -0.01007584 2.69174194 -0.02035522 C5.62804763 -0.03935224 8.56412496 -0.04326028 11.50048828 -0.04541016 C13.54306126 -0.05183686 15.58563331 -0.05856513 17.62820435 -0.06558228 C21.91036107 -0.07755928 26.19243709 -0.08126266 30.47460938 -0.08007812 C35.95806313 -0.07987491 41.44099879 -0.10717841 46.92432976 -0.14162254 C51.14342621 -0.16387476 55.36239765 -0.16791618 59.58154678 -0.16685867 C61.60293488 -0.1692171 63.6243263 -0.17805423 65.64565659 -0.19352341 C68.47507621 -0.21314933 71.30337429 -0.20735865 74.1328125 -0.1953125 C74.96522461 -0.20655151 75.79763672 -0.21779053 76.65527344 -0.22937012 C81.95825332 -0.1720841 85.00706613 0.74509173 89.19580078 4.29052734 C90.69696012 6.63372965 91.86485333 8.72626895 93.00830078 11.22802734 C93.4965332 12.24920654 93.4965332 12.24920654 93.99462891 13.29101562 C97.68961117 21.12626393 101.12342403 29.09071621 104.50830078 37.06396484 C104.83443359 37.83144043 105.16056641 38.59891602 105.49658203 39.38964844 C106.19580078 41.29052734 106.19580078 41.29052734 106.19580078 43.29052734 C107.45908203 43.52642578 108.72236328 43.76232422 110.02392578 44.00537109 C115.65496148 45.25658987 120.70528585 47.48694606 125.94580078 49.85302734 C127.77191886 50.67132289 129.59998698 51.48528355 131.43017578 52.29443359 C132.62465332 52.8330603 132.62465332 52.8330603 133.84326172 53.38256836 C139.65232431 55.6245675 142.90421461 55.00425251 148.55126953 52.54443359 C149.99325025 51.94854514 151.43531012 51.35284819 152.87744141 50.75732422 C155.12633566 49.81027981 157.37265694 48.85757038 159.61694336 47.8996582 C177.06119054 40.49831058 177.06119054 40.49831058 184.19580078 42.29052734 C188.59384234 44.57087049 191.8897453 47.70027242 195.34716797 51.18310547 C195.94125961 51.77369247 196.53535126 52.36427948 197.14744568 52.97276306 C199.10090189 54.91744869 201.04698914 56.86932045 202.99267578 58.82177734 C204.35047664 60.17823058 205.70857425 61.53438683 207.06695557 62.89025879 C209.90792732 65.72828592 212.74525966 68.56988942 215.58007812 71.4140625 C219.21734312 75.06274332 222.86354179 78.70234346 226.51249313 82.33933258 C229.31615718 85.13577879 232.11505157 87.93695964 234.91251373 90.73960876 C236.25549685 92.08392746 237.59997112 93.42675816 238.94594574 94.76808167 C240.82284418 96.63991385 242.6932333 98.51801496 244.56201172 100.39794922 C245.12095627 100.95284531 245.67990082 101.50774139 246.25578308 102.07945251 C249.84236152 105.70589408 251.34284491 108.35574093 251.66845703 113.42724609 C251.5877321 121.51001286 247.75254139 128.7949781 244.63330078 136.10302734 C243.68676688 138.33474555 242.74583253 140.56813423 241.8205719 142.8087616 C241.24802669 144.19425438 240.66324007 145.57477115 240.06455994 146.94917297 C237.96885611 152.00463336 238.18573915 154.67343839 240.10375977 159.64306641 C240.46284424 160.43938477 240.82192871 161.23570312 241.19189453 162.05615234 C241.58570313 162.94689453 241.97951172 163.83763672 242.38525391 164.75537109 C243.21080192 166.59767386 244.03888779 168.43884169 244.86962891 170.27880859 C246.80982891 174.67828332 248.30743851 178.49133423 248.91845703 183.27490234 C249.27528275 185.47053307 249.27528275 185.47053307 250.19580078 187.29052734 C252.22023734 188.54677198 254.08529098 189.01170983 256.40087891 189.56835938 C262.15901247 191.056179 267.52471839 193.81702591 272.94580078 196.22802734 C274.15107422 196.75332031 275.35634766 197.27861328 276.59814453 197.81982422 C277.75958984 198.33480469 278.92103516 198.84978516 280.11767578 199.38037109 C281.16536133 199.84306396 282.21304687 200.30575684 283.29248047 200.7824707 C287.79166331 203.11945796 291.42924384 205.41850885 293.19580078 210.29052734 C293.39744604 213.25634414 293.48954215 216.12861145 293.48632812 219.09472656 C293.49640396 220.42713882 293.49640396 220.42713882 293.50668335 221.78646851 C293.52568037 224.7227742 293.5295884 227.65885152 293.53173828 230.59521484 C293.53816499 232.63778782 293.54489325 234.68035987 293.5519104 236.72293091 C293.5638874 241.00508763 293.56759078 245.28716365 293.56640625 249.56933594 C293.56620303 255.05278969 293.59350654 260.53572535 293.62795067 266.01905632 C293.65020289 270.23815278 293.6542443 274.45712421 293.6531868 278.67627335 C293.65554523 280.69766145 293.66438236 282.71905286 293.67985153 284.74038315 C293.69947746 287.56980277 293.69368677 290.39810085 293.68164062 293.22753906 C293.69287964 294.05995117 293.70411865 294.89236328 293.71569824 295.75 C293.65841222 301.05297988 292.74123639 304.1017927 289.19580078 308.29052734 C286.85259848 309.79168669 284.76005918 310.95957989 282.25830078 312.10302734 C281.23712158 312.59125977 281.23712158 312.59125977 280.1953125 313.08935547 C272.3600642 316.78433773 264.39561192 320.21815059 256.42236328 323.60302734 C255.6548877 323.92916016 254.88741211 324.25529297 254.09667969 324.59130859 C252.19580078 325.29052734 252.19580078 325.29052734 250.19580078 325.29052734 C249.95990234 326.55380859 249.72400391 327.81708984 249.48095703 329.11865234 C248.22973825 334.74968804 245.99938206 339.80001241 243.63330078 345.04052734 C242.81500523 346.86664542 242.00104457 348.69471354 241.19189453 350.52490234 C240.65326782 351.71937988 240.65326782 351.71937988 240.10375977 352.93798828 C237.86176062 358.74705087 238.48207562 361.99894117 240.94189453 367.64599609 C241.53778298 369.08797681 242.13347994 370.53003668 242.72900391 371.97216797 C243.67604831 374.22106222 244.62875775 376.4673835 245.58666992 378.71166992 C252.98801755 396.15591711 252.98801755 396.15591711 251.19580078 403.29052734 C248.91545764 407.6885689 245.7860557 410.98447186 242.30322266 414.44189453 C241.41734215 415.333032 241.41734215 415.333032 240.51356506 416.24217224 C238.56887943 418.19562845 236.61700767 420.1417157 234.66455078 422.08740234 C233.30809755 423.44520321 231.95194129 424.80330081 230.59606934 426.16168213 C227.75804221 429.00265388 224.9164387 431.83998623 222.07226562 434.67480469 C218.42358481 438.31206968 214.78398467 441.95826835 211.14699554 445.6072197 C208.35054934 448.41088375 205.54936849 451.20977813 202.74671936 454.0072403 C201.40240067 455.35022341 200.05956996 456.69469769 198.71824646 458.0406723 C196.84641427 459.91757075 194.96831316 461.78795986 193.08837891 463.65673828 C192.53348282 464.21568283 191.97858673 464.77462738 191.40687561 465.35050964 C187.78043404 468.93708808 185.13058719 470.43757148 180.05908203 470.76318359 C171.97631526 470.68245867 164.69135002 466.84726795 157.38330078 463.72802734 C155.15158258 462.78149344 152.9181939 461.84055909 150.67756653 460.91529846 C149.29207375 460.34275326 147.91155697 459.75796663 146.53715515 459.1592865 C141.48169476 457.06358267 138.81288974 457.28046572 133.84326172 459.19848633 C133.04694336 459.5575708 132.250625 459.91665527 131.43017578 460.28662109 C130.53943359 460.68042969 129.64869141 461.07423828 128.73095703 461.47998047 C126.88865427 462.30552848 125.04748643 463.13361435 123.20751953 463.96435547 C118.8080448 465.90455547 114.9949939 467.40216508 110.21142578 468.01318359 C108.01579506 468.37000931 108.01579506 468.37000931 106.19580078 469.29052734 C104.93955615 471.31496391 104.47461829 473.18001754 103.91796875 475.49560547 C102.43014912 481.25373903 99.66930221 486.61944496 97.25830078 492.04052734 C96.73300781 493.24580078 96.20771484 494.45107422 95.66650391 495.69287109 C95.15152344 496.85431641 94.63654297 498.01576172 94.10595703 499.21240234 C93.64326416 500.26008789 93.18057129 501.30777344 92.70385742 502.38720703 C90.36687017 506.88638987 88.06781927 510.5239704 83.19580078 512.29052734 C80.22998399 512.4921726 77.35771667 512.58426871 74.39160156 512.58105469 C73.0591893 512.59113052 73.0591893 512.59113052 71.69985962 512.60140991 C68.76355393 512.62040693 65.8274766 512.62431496 62.89111328 512.62646484 C60.8485403 512.63289155 58.80596825 512.63961981 56.76339722 512.64663696 C52.4812405 512.65861397 48.19916448 512.66231734 43.91699219 512.66113281 C38.43353843 512.66092959 32.95060278 512.6882331 27.4672718 512.72267723 C23.24817535 512.74492945 19.02920391 512.74897087 14.81005478 512.74791336 C12.78866668 512.75027179 10.76727526 512.75910892 8.74594498 512.77457809 C5.91652535 512.79420402 3.08822727 512.78841333 0.25878906 512.77636719 C-0.57362305 512.7876062 -1.40603516 512.79884521 -2.26367188 512.8104248 C-7.56665175 512.75313879 -10.61546457 511.83596296 -14.80419922 508.29052734 C-16.30535856 505.94732504 -17.47325177 503.85478574 -18.61669922 501.35302734 C-18.9421875 500.67224121 -19.26767578 499.99145508 -19.60302734 499.29003906 C-23.29800961 491.45479076 -26.73182247 483.49033848 -30.11669922 475.51708984 C-30.44283203 474.74961426 -30.76896484 473.98213867 -31.10498047 473.19140625 C-31.80419922 471.29052734 -31.80419922 471.29052734 -31.80419922 469.29052734 C-33.06748047 469.05462891 -34.33076172 468.81873047 -35.63232422 468.57568359 C-41.26335992 467.32446482 -46.31368428 465.09410862 -51.55419922 462.72802734 C-53.3803173 461.90973179 -55.20838542 461.09577114 -57.03857422 460.28662109 C-58.23305176 459.74799438 -58.23305176 459.74799438 -59.45166016 459.19848633 C-65.26072274 456.95648718 -68.51261305 457.57680218 -74.15966797 460.03662109 C-75.60164869 460.63250955 -77.04370856 461.2282065 -78.48583984 461.82373047 C-80.73473409 462.77077488 -82.98105537 463.72348431 -85.2253418 464.68139648 C-102.66958898 472.08274411 -102.66958898 472.08274411 -109.80419922 470.29052734 C-114.20224078 468.0101842 -117.49814373 464.88078226 -120.95556641 461.39794922 C-121.54965805 460.80736221 -122.14374969 460.21677521 -122.75584412 459.60829163 C-124.70930032 457.66360599 -126.65538757 455.71173424 -128.60107422 453.75927734 C-129.95887508 452.40282411 -131.31697269 451.04666785 -132.675354 449.6907959 C-135.51632576 446.85276877 -138.3536581 444.01116527 -141.18847656 441.16699219 C-144.82574156 437.51831137 -148.47194022 433.87871123 -152.12089157 430.24172211 C-154.92455562 427.4452759 -157.72345 424.64409505 -160.52091217 421.84144592 C-161.86389529 420.49712723 -163.20836956 419.15429653 -164.55434418 417.81297302 C-166.43124262 415.94114083 -168.30163174 414.06303972 -170.17041016 412.18310547 C-170.72935471 411.62820938 -171.28829926 411.07331329 -171.86418152 410.50160217 C-175.45075996 406.8751606 -176.95124335 404.22531376 -177.27685547 399.15380859 C-177.19613054 391.07104183 -173.36093982 383.78607658 -170.24169922 376.47802734 C-169.29516532 374.24630914 -168.35423097 372.01292046 -167.42897034 369.77229309 C-166.85642513 368.38680031 -166.27163851 367.00628353 -165.67295837 365.63188171 C-163.57725455 360.57642133 -163.79413759 357.9076163 -165.7121582 352.93798828 C-166.07124268 352.14166992 -166.43032715 351.34535156 -166.80029297 350.52490234 C-167.19410156 349.63416016 -167.58791016 348.74341797 -167.99365234 347.82568359 C-168.81920036 345.98338083 -169.64728623 344.14221299 -170.47802734 342.30224609 C-172.41822735 337.90277137 -173.91583695 334.08972046 -174.52685547 329.30615234 C-174.88368118 327.11052162 -174.88368118 327.11052162 -175.80419922 325.29052734 C-177.82863578 324.03428271 -179.69368941 323.56934485 -182.00927734 323.01269531 C-187.76741091 321.52487569 -193.13311683 318.76402877 -198.55419922 316.35302734 C-199.75947266 315.82773437 -200.96474609 315.30244141 -202.20654297 314.76123047 C-203.36798828 314.24625 -204.52943359 313.73126953 -205.72607422 313.20068359 C-206.77375977 312.73799072 -207.82144531 312.27529785 -208.90087891 311.79858398 C-213.40006175 309.46159673 -217.03764228 307.16254584 -218.80419922 302.29052734 C-219.00584448 299.32471055 -219.09794059 296.45244324 -219.09472656 293.48632812 C-219.10144379 292.59805328 -219.10816101 291.70977844 -219.11508179 290.79458618 C-219.1340788 287.85828049 -219.13798684 284.92220316 -219.14013672 281.98583984 C-219.14656342 279.94326687 -219.15329169 277.90069481 -219.16030884 275.85812378 C-219.17228584 271.57596706 -219.17598922 267.29389104 -219.17480469 263.01171875 C-219.17460147 257.52826499 -219.20190497 252.04532934 -219.23634911 246.56199837 C-219.25860132 242.34290191 -219.26264274 238.12393047 -219.26158524 233.90478134 C-219.26394367 231.88339324 -219.27278079 229.86200182 -219.28824997 227.84067154 C-219.3078759 225.01125191 -219.30208521 222.18295384 -219.29003906 219.35351562 C-219.30127808 218.52110352 -219.31251709 217.68869141 -219.32409668 216.83105469 C-219.26681066 211.52807481 -218.34963483 208.47926199 -214.80419922 204.29052734 C-212.46099692 202.789368 -210.36845761 201.6214748 -207.86669922 200.47802734 C-207.18591309 200.15253906 -206.50512695 199.82705078 -205.80371094 199.49169922 C-197.96846264 195.79671696 -190.00401035 192.3629041 -182.03076172 188.97802734 C-181.26328613 188.65189453 -180.49581055 188.32576172 -179.70507812 187.98974609 C-177.80419922 187.29052734 -177.80419922 187.29052734 -175.80419922 187.29052734 C-175.56830078 186.02724609 -175.33240234 184.76396484 -175.08935547 183.46240234 C-173.83813669 177.83136665 -171.6077805 172.78104228 -169.24169922 167.54052734 C-168.42340367 165.71440926 -167.60944301 163.88634115 -166.80029297 162.05615234 C-166.26166626 160.8616748 -166.26166626 160.8616748 -165.7121582 159.64306641 C-163.47015906 153.83400382 -164.09047406 150.58211352 -166.55029297 144.93505859 C-167.14618142 143.49307787 -167.74187837 142.05101801 -168.33740234 140.60888672 C-169.28444675 138.35999247 -170.23715619 136.11367119 -171.19506836 133.86938477 C-178.59641598 116.42513758 -178.59641598 116.42513758 -176.80419922 109.29052734 C-174.52385607 104.89248579 -171.39445414 101.59658283 -167.91162109 98.13916016 C-167.32103409 97.54506851 -166.73044708 96.95097687 -166.1219635 96.33888245 C-164.17727787 94.38542624 -162.22540611 92.43933899 -160.27294922 90.49365234 C-158.91649598 89.13585148 -157.56033973 87.77775387 -156.20446777 86.41937256 C-153.36644065 83.57840081 -150.52483714 80.74106846 -147.68066406 77.90625 C-144.03198324 74.26898501 -140.3923831 70.62278634 -136.75539398 66.97383499 C-133.95894778 64.17017094 -131.15776692 61.37127656 -128.3551178 58.57381439 C-127.0107991 57.23083127 -125.6679684 55.886357 -124.3266449 54.54038239 C-122.45481271 52.66348394 -120.5767116 50.79309483 -118.69677734 48.92431641 C-118.14188126 48.36537186 -117.58698517 47.80642731 -117.01527405 47.23054504 C-113.38883248 43.64396661 -110.73898563 42.14348321 -105.66748047 41.81787109 C-97.5847137 41.89859602 -90.29974846 45.73378674 -82.99169922 48.85302734 C-80.75998102 49.79956124 -78.52659233 50.7404956 -76.28596497 51.66575623 C-74.90047218 52.23830143 -73.51995541 52.82308806 -72.14555359 53.42176819 C-67.0900932 55.51747202 -64.42128818 55.30058897 -59.45166016 53.38256836 C-58.6553418 53.02348389 -57.85902344 52.66439941 -57.03857422 52.29443359 C-56.14783203 51.900625 -55.25708984 51.50681641 -54.33935547 51.10107422 C-52.4970527 50.27552621 -50.65588487 49.44744034 -48.81591797 48.61669922 C-44.41644324 46.67649921 -40.60339233 45.17888961 -35.81982422 44.56787109 C-33.62419349 44.21104538 -33.62419349 44.21104538 -31.80419922 43.29052734 C-30.54795459 41.26609078 -30.08301673 39.40103715 -29.52636719 37.08544922 C-28.03854756 31.32731566 -25.27770065 25.96160973 -22.86669922 20.54052734 C-22.34140625 19.33525391 -21.81611328 18.12998047 -21.27490234 16.88818359 C-20.75992188 15.72673828 -20.24494141 14.56529297 -19.71435547 13.36865234 C-19.2516626 12.3209668 -18.78896973 11.27328125 -18.31225586 10.19384766 C-13.74959916 1.40979174 -9.54910642 -0.01034722 0 0 Z " fill="%2393C6EC" transform="translate(218.80419921875,-0.29052734375)"/><path d="M0 0 C46 0 46 0 52 4 C53.50115934 6.3432023 54.66905255 8.4357416 55.8125 10.9375 C56.13798828 11.61828613 56.46347656 12.29907227 56.79882812 13.00048828 C60.49381039 20.83573658 63.92762325 28.80018886 67.3125 36.7734375 C67.63863281 37.54091309 67.96476562 38.30838867 68.30078125 39.09912109 C69 41 69 41 69 43 C70.26328125 43.23589844 71.5265625 43.47179688 72.828125 43.71484375 C78.4591607 44.96606253 83.50948507 47.19641872 88.75 49.5625 C90.57611808 50.38079555 92.4041862 51.19475621 94.234375 52.00390625 C95.03069336 52.36299072 95.82701172 52.7220752 96.64746094 53.09204102 C102.45652352 55.33404016 105.70841383 54.71372516 111.35546875 52.25390625 C112.79744947 51.6580178 114.23950934 51.06232084 115.68164062 50.46679688 C117.93053487 49.51975247 120.17685616 48.56704303 122.42114258 47.60913086 C139.86538976 40.20778323 139.86538976 40.20778323 147 42 C151.39804156 44.28034315 154.69394452 47.40974508 158.15136719 50.89257812 C158.74545883 51.48316513 159.33955048 52.07375214 159.9516449 52.68223572 C161.9051011 54.62692135 163.85118836 56.57879311 165.796875 58.53125 C167.15467586 59.88770323 168.51277347 61.24385949 169.87115479 62.59973145 C172.71212654 65.43775857 175.54945888 68.27936208 178.38427734 71.12353516 C182.02154234 74.77221597 185.667741 78.41181611 189.31669235 82.04880524 C192.1203564 84.84525144 194.91925078 87.64643229 197.71671295 90.44908142 C199.05969607 91.79340011 200.40417034 93.13623082 201.75014496 94.47755432 C203.6270434 96.34938651 205.49743252 98.22748762 207.36621094 100.10742188 C207.92515549 100.66231796 208.48410004 101.21721405 209.0599823 101.78892517 C212.64656074 105.41536674 214.14704413 108.06521359 214.47265625 113.13671875 C214.39193132 121.21948552 210.5567406 128.50445076 207.4375 135.8125 C206.4909661 138.0442182 205.55003175 140.27760689 204.62477112 142.51823425 C204.05222591 143.90372704 203.46743929 145.28424381 202.86875916 146.65864563 C200.77305533 151.71410602 200.98993837 154.38291104 202.90795898 159.35253906 C203.26704346 160.14885742 203.62612793 160.94517578 203.99609375 161.765625 C204.38990234 162.65636719 204.78371094 163.54710937 205.18945312 164.46484375 C206.01500114 166.30714651 206.84308701 168.14831435 207.67382812 169.98828125 C209.61402813 174.38775598 211.11163773 178.20080689 211.72265625 182.984375 C212.07948197 185.18000572 212.07948197 185.18000572 213 187 C215.02443656 188.25624463 216.8894902 188.72118249 219.20507812 189.27783203 C224.96321169 190.76565166 230.32891761 193.52649857 235.75 195.9375 C236.95527344 196.46279297 238.16054688 196.98808594 239.40234375 197.52929688 C240.56378906 198.04427734 241.72523438 198.55925781 242.921875 199.08984375 C243.96956055 199.55253662 245.01724609 200.01522949 246.09667969 200.49194336 C250.59586253 202.82893061 254.23344306 205.12798151 256 210 C256.20164526 212.96581679 256.29374137 215.83808411 256.29052734 218.80419922 C256.29724457 219.69247406 256.30396179 220.5807489 256.31088257 221.49594116 C256.32987959 224.43224685 256.33378762 227.36832418 256.3359375 230.3046875 C256.34236421 232.34726048 256.34909247 234.38983253 256.35610962 236.43240356 C256.36808662 240.71456028 256.37179 244.9966363 256.37060547 249.27880859 C256.37040225 254.76226235 256.39770576 260.245198 256.43214989 265.72852898 C256.4544021 269.94762543 256.45844352 274.16659687 256.45738602 278.385746 C256.45974445 280.4071341 256.46858158 282.42852552 256.48405075 284.4498558 C256.50367668 287.27927543 256.49788599 290.10757351 256.48583984 292.93701172 C256.49707886 293.76942383 256.50831787 294.60183594 256.51989746 295.45947266 C256.46261144 300.76245254 255.54543561 303.81126535 252 308 C249.6567977 309.50115934 247.5642584 310.66905255 245.0625 311.8125 C244.0413208 312.30073242 244.0413208 312.30073242 242.99951172 312.79882812 C235.16426342 316.49381039 227.19981114 319.92762325 219.2265625 323.3125 C218.45908691 323.63863281 217.69161133 323.96476562 216.90087891 324.30078125 C215 325 215 325 213 325 C212.76410156 326.26328125 212.52820313 327.5265625 212.28515625 328.828125 C211.03393747 334.4591607 208.80358128 339.50948507 206.4375 344.75 C205.61920445 346.57611808 204.80524379 348.4041862 203.99609375 350.234375 C203.63700928 351.03069336 203.2779248 351.82701172 202.90795898 352.64746094 C200.66595984 358.45652352 201.28627484 361.70841383 203.74609375 367.35546875 C204.3419822 368.79744947 204.93767916 370.23950934 205.53320312 371.68164062 C206.48024753 373.93053487 207.43295697 376.17685616 208.39086914 378.42114258 C215.79221677 395.86538976 215.79221677 395.86538976 214 403 C211.71965685 407.39804156 208.59025492 410.69394452 205.10742188 414.15136719 C204.51683487 414.74545883 203.92624786 415.33955048 203.31776428 415.9516449 C201.37307865 417.9051011 199.42120689 419.85118836 197.46875 421.796875 C196.11229677 423.15467586 194.75614051 424.51277347 193.40026855 425.87115479 C190.56224143 428.71212654 187.72063792 431.54945888 184.87646484 434.38427734 C181.22778403 438.02154234 177.58818389 441.667741 173.95119476 445.31669235 C171.15474856 448.1203564 168.35356771 450.91925078 165.55091858 453.71671295 C164.20659989 455.05969607 162.86376918 456.40417034 161.52244568 457.75014496 C159.65061349 459.6270434 157.77251238 461.49743252 155.89257812 463.36621094 C155.33768204 463.92515549 154.78278595 464.48410004 154.21107483 465.0599823 C150.58463326 468.64656074 147.93478641 470.14704413 142.86328125 470.47265625 C134.78051448 470.39193132 127.49554924 466.5567406 120.1875 463.4375 C117.9557818 462.4909661 115.72239311 461.55003175 113.48176575 460.62477112 C112.09627296 460.05222591 110.71575619 459.46743929 109.34135437 458.86875916 C104.28589398 456.77305533 101.61708896 456.98993837 96.64746094 458.90795898 C95.85114258 459.26704346 95.05482422 459.62612793 94.234375 459.99609375 C93.34363281 460.38990234 92.45289063 460.78371094 91.53515625 461.18945312 C89.69285349 462.01500114 87.85168565 462.84308701 86.01171875 463.67382812 C81.61224402 465.61402813 77.79919311 467.11163773 73.015625 467.72265625 C70.81999428 468.07948197 70.81999428 468.07948197 69 469 C67.74375537 471.02443656 67.27881751 472.8894902 66.72216797 475.20507812 C65.23434834 480.96321169 62.47350143 486.32891761 60.0625 491.75 C59.53720703 492.95527344 59.01191406 494.16054688 58.47070312 495.40234375 C57.95572266 496.56378906 57.44074219 497.72523438 56.91015625 498.921875 C56.44746338 499.96956055 55.98477051 501.01724609 55.50805664 502.09667969 C52.98235365 506.95917928 50.9448105 509.52759475 46 512 C30.82 512 15.64 512 0 512 C0 448.64 0 385.28 0 320 C7.92 318.02 7.92 318.02 16 316 C28.30382989 310.86344966 37.41221537 303.34392424 43 291 C45.71387386 283.71562465 46.46722701 277.06080585 46.46875 269.32421875 C46.47636353 268.23720169 46.48397705 267.15018463 46.49182129 266.03022766 C46.5025658 263.74356365 46.50549857 261.4568508 46.50097656 259.17016602 C46.50000547 255.706996 46.54167125 252.24605363 46.5859375 248.78320312 C46.66907946 233.38236968 45.69048804 220.96064503 35 209 C34.49984375 208.39671875 33.9996875 207.7934375 33.484375 207.171875 C24.85017755 197.53175164 12.20780239 194.44156048 0 192 C0 128.64 0 65.28 0 0 Z " fill="%2378B7EA" transform="translate(256,0)"/><path d="M0 0 C1.24923156 1.03883466 2.47843653 2.10217863 3.6875 3.1875 C4.36425781 3.76113281 5.04101562 4.33476562 5.73828125 4.92578125 C11.47180273 10.1410183 14.71256073 16.08175333 17.6875 23.1875 C18.03586914 24.00444336 18.38423828 24.82138672 18.74316406 25.66308594 C20.0728523 30.62569694 20.01255919 35.39062748 20.0234375 40.5078125 C20.0334227 42.15038528 20.0334227 42.15038528 20.04360962 43.82614136 C20.05371689 46.14091315 20.05842724 48.45571397 20.05810547 50.77050781 C20.06245943 54.2797975 20.09874825 57.78780915 20.13671875 61.296875 C20.14259141 63.55468324 20.14655779 65.8124974 20.1484375 68.0703125 C20.16280853 69.10511749 20.17717957 70.13992249 20.19198608 71.20608521 C20.10436824 85.45653317 14.43459453 96.08102201 5 106.4375 C-4.26802453 115.36226436 -15.95498516 118.58011673 -28.41821289 118.48071289 C-41.67229978 118.20008234 -51.5613872 113.52393161 -61.5 104.75 C-74.2110325 91.3824059 -74.56715936 75.3503873 -74.66259766 57.99609375 C-74.67909223 55.80457899 -74.70629528 53.61311656 -74.74462891 51.421875 C-75.03618465 34.62826391 -74.61126297 20.00592901 -62.3125 7.1875 C-45.86434926 -9.65883689 -19.8139292 -14.04288186 0 0 Z " fill="%23D7F0FA" transform="translate(283.3125,200.8125)"/><path d="M0 0 C0.81863022 -0.01283524 1.63726044 -0.02567047 2.48069763 -0.03889465 C3.35984329 -0.04628159 4.23898895 -0.05366852 5.14477539 -0.0612793 C6.06271378 -0.06935104 6.98065216 -0.07742279 7.92640686 -0.08573914 C9.87230555 -0.09956221 11.8182283 -0.1102923 13.76416016 -0.11816406 C15.73363461 -0.1296267 17.70307943 -0.14998661 19.67236328 -0.1796875 C37.05882227 -0.44167724 51.52390371 0.99274063 65.05493164 13.20825195 C76.20845315 24.86875172 78.46515007 37.07301655 78.21118164 52.5246582 C77.69601939 63.58040806 72.49115022 73.29578418 64.80493164 81.17700195 C53.44485152 91.34850226 40.67276544 94.70445574 25.67993164 94.36450195 C24.53266602 94.3509668 23.38540039 94.33743164 22.20336914 94.32348633 C19.40338206 94.28848649 16.60441947 94.23939054 13.80493164 94.17700195 C13.85206299 95.1671228 13.85206299 95.1671228 13.90014648 96.17724609 C14.02565433 99.19764272 14.10314731 102.21748994 14.17993164 105.23950195 C14.23020508 106.2778418 14.28047852 107.31618164 14.33227539 108.38598633 C14.4321915 113.63158223 14.39899816 117.20700002 10.93383789 121.33325195 C7.33426994 124.93337206 4.44458414 126.02794264 -0.63256836 126.48950195 C-6.05017001 126.01427374 -9.47352302 124.24773613 -13.00756836 120.17700195 C-15.60726252 116.61170711 -16.31773811 114.24059227 -16.34223938 109.94633484 C-16.34939468 109.08422394 -16.35654999 108.22211304 -16.36392212 107.33387756 C-16.36661102 106.39096359 -16.36929993 105.44804962 -16.37207031 104.4765625 C-16.37864151 103.48114441 -16.38521271 102.48572632 -16.39198303 101.46014404 C-16.4117169 98.16133552 -16.42337821 94.8625725 -16.43334961 91.5637207 C-16.43742514 90.43760691 -16.44150066 89.31149311 -16.44569969 88.15125465 C-16.46655973 82.19214689 -16.48086237 76.23306216 -16.49023438 70.27392578 C-16.50130511 64.11677134 -16.53571321 57.95997767 -16.57540607 51.80295086 C-16.60153876 47.07002587 -16.6099232 42.33718734 -16.61351585 37.60419655 C-16.6183896 35.33439507 -16.63002589 33.06459765 -16.64855385 30.79486656 C-16.67287579 27.61816082 -16.67199276 24.44239515 -16.66503906 21.265625 C-16.67784912 20.32878372 -16.69065918 19.39194244 -16.70385742 18.42671204 C-16.64894711 11.54241673 -14.7144645 8.09005375 -10.19506836 2.86450195 C-7.07373731 0.23087888 -3.98644338 0.05482471 0 0 Z " fill="%23D7F0FA" transform="translate(345.195068359375,192.822998046875)"/><path d="M0 0 C0.77633789 -0.00428513 1.55267578 -0.00857025 2.35253906 -0.01298523 C3.98631825 -0.01870255 5.62012287 -0.01924804 7.25390625 -0.01489258 C9.74263128 -0.01172812 12.23017122 -0.03523846 14.71875 -0.06054688 C16.31249851 -0.06281983 17.9062502 -0.06352338 19.5 -0.0625 C20.23766602 -0.07170975 20.97533203 -0.08091949 21.73535156 -0.09040833 C28.05393474 -0.03425827 31.90796641 1.69901291 36.625 5.80078125 C39.45330724 9.46202039 39.39547658 13.19147235 39.1640625 17.6796875 C38.35464326 22.80346401 36.02759039 25.28281815 32.078125 28.4296875 C26.10154765 31.74550788 18.71466457 30.82969378 12.0625 30.80078125 C9.26624692 30.78871886 6.47186963 30.80242668 3.67578125 30.83203125 C2.44255127 30.82751953 1.20932129 30.82300781 -0.0612793 30.81835938 C-3.81872214 31.38682328 -4.97459187 32.32105534 -7.25 35.30078125 C-7.87222293 37.27813202 -7.87222293 37.27813202 -7.75 39.30078125 C-7.7603125 39.96078125 -7.770625 40.62078125 -7.78125 41.30078125 C-7.00399825 44.2269055 -5.57320822 45.39551628 -3.25 47.30078125 C-0.52367056 47.89091473 -0.52367056 47.89091473 2.4765625 47.8046875 C4.14912109 47.83272461 4.14912109 47.83272461 5.85546875 47.86132812 C7.59763672 47.86229492 7.59763672 47.86229492 9.375 47.86328125 C23.12757567 47.91779316 33.58517941 49.74021634 43.9140625 59.3046875 C52.60343647 68.40086736 55.44696179 76.99666748 55.27832031 89.37133789 C55.01590974 95.62858053 53.94588136 100.83792523 50.75 106.30078125 C50.151875 107.35265625 49.55375 108.40453125 48.9375 109.48828125 C43.43301459 116.56547677 38.01742107 120.75190436 29.75 124.30078125 C29.0475415 124.64536377 28.34508301 124.98994629 27.62133789 125.3449707 C23.8691176 126.59400926 20.2906124 126.62533381 16.37890625 126.63671875 C15.57895737 126.64337555 14.77900848 126.65003235 13.95481873 126.65689087 C12.26799814 126.66698636 10.58113787 126.67170885 8.89428711 126.67138672 C6.32403385 126.67576162 3.75549692 126.71211618 1.18554688 126.75 C-0.4583275 126.75586866 -2.10220998 126.75983772 -3.74609375 126.76171875 C-4.5087706 126.77608978 -5.27144745 126.79046082 -6.05723572 126.80526733 C-12.11633788 126.75378369 -15.45907511 124.70675098 -20.0625 120.73828125 C-23.03610127 117.13865866 -22.64051926 112.45679109 -22.59375 108.03125 C-22.0409117 103.6399549 -20.57711861 102.19392787 -17.25 99.30078125 C-12.6845154 96.56630786 -9.35300475 95.94067624 -4.05859375 95.96484375 C-2.68814624 95.95233882 -1.31770349 95.93930205 0.05273438 95.92578125 C2.18791551 95.92184679 4.32262675 95.9258504 6.45776367 95.94042969 C8.53634532 95.94902183 10.61299492 95.92730032 12.69140625 95.90234375 C14.54294312 95.90741943 14.54294312 95.90741943 16.43188477 95.91259766 C20.66223589 95.13257706 22.16619813 93.68179512 24.75 90.30078125 C24.67607229 86.01297402 24.1333231 83.87576591 21.75 80.30078125 C18.64193594 79.2647599 16.41637757 79.16138068 13.15625 79.125 C12.0425 79.10115234 10.92875 79.07730469 9.78125 79.05273438 C7.45851001 79.01033923 5.13554249 78.97878303 2.8125 78.95898438 C-10.32811209 78.63498993 -19.57990196 74.71406797 -29 65.609375 C-37.59234782 56.35112022 -38.7151002 45.79843195 -38.53515625 33.7421875 C-38.32030161 28.56948112 -37.06645888 24.64728872 -34.25 20.30078125 C-33.651875 19.26953125 -33.05375 18.23828125 -32.4375 17.17578125 C-24.14360607 6.27523495 -13.93979968 -0.01722302 0 0 Z " fill="%23EFF4FE" transform="translate(135.25,192.69921875)"/><path d="M0 0 C0 9.57 0 19.14 0 29 C-2.97 30.32 -5.94 31.64 -9 33 C-12.64697327 36.10380704 -15.60893184 39.09914267 -16.26742554 43.98370361 C-16.27504913 44.67905212 -16.28267273 45.37440063 -16.29052734 46.09082031 C-16.30328705 46.88554749 -16.31604675 47.68027466 -16.32919312 48.49908447 C-16.33141876 49.35016785 -16.33364441 50.20125122 -16.3359375 51.078125 C-16.3425943 51.96352966 -16.3492511 52.84893433 -16.35610962 53.76116943 C-16.36622542 55.63389005 -16.37092697 57.50664663 -16.37060547 59.37939453 C-16.37496357 62.22620119 -16.41125186 65.07143781 -16.44921875 67.91796875 C-16.45509038 69.74218223 -16.45905746 71.56640304 -16.4609375 73.390625 C-16.47530853 74.23361145 -16.48967957 75.0765979 -16.50448608 75.94512939 C-16.45793188 82.05325485 -15.61788688 85.98182925 -12 91 C-8.04 92.98 -4.08 94.96 0 97 C0 106.57 0 116.14 0 126 C-13.9264616 126 -23.74142553 121.78442512 -34.1875 112.5625 C-46.8985325 99.1949059 -47.25465936 83.1628873 -47.35009766 65.80859375 C-47.36659223 63.61707899 -47.39379528 61.42561656 -47.43212891 59.234375 C-47.72368465 42.44076391 -47.29876297 27.81842901 -35 15 C-24.96063991 4.71760139 -14.36028125 0 0 0 Z " fill="%23EFF4FE" transform="translate(256,193)"/><path d="M0 0 C4.8215804 3.17785981 8.05470361 6.2444623 9.75 11.8125 C10.04307499 14.73818151 10.05410704 17.64729873 10.05078125 20.5859375 C10.05506638 21.4279068 10.0593515 22.2698761 10.06376648 23.13735962 C10.06949516 24.9141551 10.07002084 26.69097404 10.06567383 28.46777344 C10.06251851 31.17163575 10.08597453 33.87439814 10.11132812 36.578125 C10.11360189 38.30989446 10.11430425 40.04166685 10.11328125 41.7734375 C10.122491 42.57470062 10.13170074 43.37596375 10.14118958 44.20150757 C10.09233891 50.19446118 9.11185276 55.11784071 5.03125 59.7734375 C4.4434375 60.24007812 3.855625 60.70671875 3.25 61.1875 C2.6621875 61.66960937 2.074375 62.15171875 1.46875 62.6484375 C-2.70227637 65.47335991 -7.41429884 65.48542929 -12.25 64.8125 C-18.03859472 62.63923812 -20.73613995 59.56100048 -23.38587952 54.11352539 C-24.84846487 50.21887633 -24.84102133 46.46508949 -24.81640625 42.34375 C-24.82260483 41.46400513 -24.82880341 40.58426025 -24.83518982 39.67785645 C-24.84225259 37.82903136 -24.83917635 35.9801422 -24.82641602 34.13134766 C-24.81253425 31.31943726 -24.84669094 28.51084978 -24.88476562 25.69921875 C-24.88571688 23.89322836 -24.88385763 22.08723385 -24.87890625 20.28125 C-24.89879356 19.03559265 -24.89879356 19.03559265 -24.91908264 17.76477051 C-24.82316817 11.68512631 -23.16622062 7.49625358 -19.25 2.8125 C-13.4562053 -2.07887497 -7.02734612 -2.56768416 0 0 Z " fill="%2393C6EC" transform="translate(263.25,224.1875)"/><path d="M0 0 C5.506875 -0.12375 5.506875 -0.12375 11.125 -0.25 C12.2711377 -0.28641602 13.41727539 -0.32283203 14.59814453 -0.36035156 C20.74920075 -0.42722259 24.35258666 -0.15622331 29 4 C33.82911404 9.48169702 34.36430815 12.80787083 34.26953125 20.01953125 C33.83319993 24.84447032 32.05918658 27.27347071 28.41015625 30.33300781 C22.52272736 34.49963957 17.54448575 34.61059275 10.5 34.3125 C7.035 34.209375 3.57 34.10625 0 34 C0 22.78 0 11.56 0 0 Z " fill="%2379B7EA" transform="translate(359,223)"/><path d="M0 0 C8.65789474 1.23684211 8.65789474 1.23684211 13 5 C16.73905298 10.51271084 17.58914417 15.52430677 17.49609375 22.06640625 C17.49754898 22.90413071 17.49900421 23.74185516 17.50050354 24.60496521 C17.49885406 26.36387637 17.48740027 28.12280341 17.46655273 29.8815918 C17.43753728 32.55905991 17.44597579 35.23455058 17.45898438 37.91210938 C17.45274727 39.63021786 17.44435654 41.34832016 17.43359375 43.06640625 C17.43652939 43.85825821 17.43946503 44.65011017 17.44248962 45.46595764 C17.34246376 51.41553125 16.2512826 56.2026142 12.421875 60.9609375 C11.87015625 61.42757812 11.3184375 61.89421875 10.75 62.375 C10.20859375 62.85710937 9.6671875 63.33921875 9.109375 63.8359375 C7 65 7 65 0 66 C0 44.22 0 22.44 0 0 Z " fill="%2378B7EA" transform="translate(256,223)"/>
</svg>
' />
</head>

<body>
  <!-- <header>
    <div class="wrap row">
      <h1>SOP Hub</h1>
      <div class="grow"></div>
      <button id="settingsBtn" class="btn">⚙️</button>
    </div>
  </header> -->



  <header>

    <div class="wrap">
      <div class="row">
        <div class="grow" style="display: flex; align-items: center; gap: 8px;">
          <h1 id="sop-run-mode-title" class="">SOP Hub</h1>
        </div>

        <div class="controls">


          <button id="settingsBtn" class="btn">⚙️</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="wrap">
        <!-- VIEW block -->
        <div id="searchWrapper">
          <div>
            <input id="searchInput" type="search" placeholder="Search ..." autocomplete="off">
          </div>
        </div>
      </div>

      <div id="viewCards" class="grid" aria-live="polite"></div>
      <div id="viewRows" class="list hidden" aria-live="polite"></div>
      <div id="empty" class="empty hidden">SOP list is not available yet.</div>
    </div>

    <section id="globalSearchSection" class="shell" style="margin-top:24px;">
      <div class="wrap">
        <div id="globalSearchStatus" class="muted" style="font-size:12px; margin-bottom:6px;"></div>
        <div id="globalSearchResults" class="list"></div>
      </div>
    </section>


  </main>


  <script>
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => [...p.querySelectorAll(s)];

    // const state = { items: [], layout: localStorage.getItem('sopHubLayout') || 'cards' };
    // const state = {
    //   items: [],
    //   layout: localStorage.getItem('sopHubLayout') || 'cards',
    //   loadingCsv: false
    // };

    // const state = {
    //   items: [],
    //   layout: localStorage.getItem('sopHubLayout') || 'cards',
    //   loadingCsv: false,
    //   csvError: null
    // };

    const state = {
      items: [],
      layout: localStorage.getItem('sopHubLayout') || '',
      groupBy: localStorage.getItem('sop-hub-groupBy') || 'org',
      loadingCsv: false,
      csvError: null,
      csvWarning: null,   // NEW: non-fatal issues (e.g. missing URL rows)

      searchQ: '',
      searchResults: [],
      searchLoading: false,
      searchError: null
    };

    let searchController = null; // AbortController for current search
    let searchSeq = 0;           // monotonically increasing search token


    const DEFAULT_CSV_PATH = './config/sop-hub-data.csv'; // put your real CSV file name here
    const DEFAULT_SOP_PATH = './sop.html'; // put your real CSV file name here
    const DEFAULT_STUDIO_PATH = './studio.html'; // put your real CSV file name here


    const viewCards = $('#viewCards');
    const viewRows = $('#viewRows');
    const empty = $('#empty');

    (function themeInit() {
      const saved = localStorage.getItem('theme');
      const prefersDark = matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(saved || (prefersDark ? 'dark' : 'light'));
    })();

    (function layoutInit() {
      const saved = localStorage.getItem('sopHubLayout');
      setLayout(saved || 'cards');
    })();

    (function groupByInit() {
      const saved = localStorage.getItem('sop-hub-groupBy');
      setGroupBy(saved || 'org');
    })();

    function setGroupBy(mode) {
      state.groupBy = mode;
      localStorage.setItem('sop-hub-groupBy', mode);
    }


    function setLayout(mode) {
      state.layout = mode;
      localStorage.setItem('sopHubLayout', mode);
      // btnCards.classList.toggle('active', mode === 'cards');
      // btnCards.setAttribute('aria-pressed', mode === 'cards');
      // btnRows.classList.toggle('active', mode === 'rows');
      // btnRows.setAttribute('aria-pressed', mode === 'rows');
      viewCards.classList.toggle('hidden', mode !== 'cards');
      viewRows.classList.toggle('hidden', mode !== 'rows');
      render();
    }

    function setTheme(mode) {
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem('theme', mode);
      // if (btn) btn.textContent = (mode === 'dark') ? '🌞 Light' : '🌙 Dark';
    }

    // btnCards.onclick = () => setLayout('cards');
    // btnRows.onclick = () => setLayout('rows');
    // settingsBtn.onclick = () => setLayout('rows');
    document.getElementById('settingsBtn')?.addEventListener('click', (e) => {
      openSettingsMenu(e.currentTarget);
    });

    function openSettingsMenu(anchorBtn) {
      // prevent duplicates
      if (document.getElementById('settingsOverlay')) return;

      // overlay (click outside to close)
      const overlay = document.createElement('div');
      overlay.id = 'settingsOverlay';
      overlay.className = 'settings-overlay';

      // panel
      const panel = document.createElement('div');
      panel.className = 'settings-panel';

      // current theme from DOM
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const currentLayout = state.layout || 'cards';
      const groupBy = state.groupBy;
      const options = [
        // { label: 'New SOP', action: 'new-sop', attrs: { 'data-hide': 'guide' } },
        // { label: 'Import', action: 'import', attrs: { 'data-hide': 'guide' } },
        // { label: 'Export', action: 'export', attrs: { 'data-hide': 'guide' } },
        { label: 'Open SOP Studio ↗', action: 'openSopStudio' },
        // { label: groupBy ? 'Ungroup SOPs' : 'Group by Org', action: 'group' },
        // { label: (currentLayout === 'cards') ? 'Rows View' : 'Cards View', action: 'layout' },
        { label: (currentTheme === 'dark') ? '🌞 Light' : '🌙 Dark', action: 'theme' },
      ];

      // build items
      panel.innerHTML = options.map(o => {
        const base = { 'data-action': o.action, ...(o.attrs || {}) }; // ensure data-action exists
        const attrs = Object.entries(base).map(([k, v]) => {
          if (v === true) return ` ${k}`;                 // boolean attribute
          if (v === false || v == null) return '';        // skip
          return ` ${k}="${String(v).replace(/"/g, '&quot;')}"`;
        }).join('');
        return `<button class="settings-item"${attrs}>${o.label}</button>`;
      }).join('');

      // place panel near the anchor button
      document.body.appendChild(overlay);
      document.body.appendChild(panel);
      const rect = anchorBtn.getBoundingClientRect();
      const top = rect.bottom + 6 + window.scrollY;
      const left = Math.min(
        rect.left + window.scrollX,
        window.scrollX + document.documentElement.clientWidth - panel.offsetWidth - 12
      );
      panel.style.top = `${top}px`;
      panel.style.left = `${left}px`;

      // handlers
      const onItemClick = async (e) => {
        const btn = e.target.closest('.settings-item');
        if (!btn) return;

        const action = btn.getAttribute('data-action');
        if (action == "openSopStudio") {
          const url = new URL(DEFAULT_STUDIO_PATH, window.location.href);
          const urlAppended = appendSource(url);
          console.log(`urlAppended`, urlAppended);

          window.open(urlAppended, '_blank');
        }
        else if (action == "layout") {
          const nextLayout = (state.layout === 'cards') ? 'rows' : 'cards';
          setLayout(nextLayout);
        }
        // else if (action == "import") {
        //   openImportDialog();
        // } else if (action == "export") {
        //   cleanup();
        //   exportCurrentHTMLAsViewer();
        // } 

        // currentLayout
        else if (action == "group") {
          setGroupBy(groupBy ? '' : 'org');
          // store it in loc
          // if (state.groupBy) {
          //   state.groupBy = '';
          // } else {
          // }
          render();
        }
        else if (action == "theme") {

          const nextTheme = (currentTheme === 'light') ? 'dark' : 'light';
          setTheme(nextTheme);
        }

        cleanup();
      };
      const onOutside = (e) => { if (e.target === overlay) cleanup(); };
      const onEsc = (e) => { if (e.key === 'Escape') cleanup(); };

      panel.addEventListener('click', onItemClick);
      overlay.addEventListener('click', onOutside);
      document.addEventListener('keydown', onEsc);

      function cleanup() {
        panel.removeEventListener('click', onItemClick);
        overlay.removeEventListener('click', onOutside);
        document.removeEventListener('keydown', onEsc);
        panel.remove();
        overlay.remove();
      }
    }

    // Basic CSV parser handling quoted fields and commas
    function parseCSV(text) {
      const rows = [];
      let cur = '', row = [], inQ = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];
        if (inQ) {
          if (c === '"' && n === '"') { cur += '"'; i++; }
          else if (c === '"') { inQ = false; }
          else { cur += c; }
        } else {
          if (c === '"') { inQ = true; }
          else if (c === ',') { row.push(cur.trim()); cur = ''; }
          else if (c === '\n' || c === '\r') { if (cur !== '' || row.length) { row.push(cur.trim()); rows.push(row); row = []; cur = ''; } }
          else { cur += c; }
        }
      }
      if (cur !== '' || row.length) { row.push(cur.trim()); rows.push(row); }
      return rows.filter(r => r.length && r.some(x => x !== ''));
    }

    function normalizeHeader(h) {
      return h.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    }

    // function rowsToObjects(rows) {
    //   const header = rows[0].map(normalizeHeader);
    //   console.log(`header`, header);
    //   const idx = (k) => header.indexOf(normalizeHeader(k));
    //   const has = (k) => idx(k) !== -1;

    //   // only url is required
    //   if (!has('url')) {
    //     throw new Error('Missing required column: url');
    //   }

    //   return rows.slice(1).map(r => {
    //     const url = r[idx('url')] || '';
    //     if (!url) return null;

    //     const org = has('org') ? (r[idx('org')] || '') : '';
    //     console.log(`org`, org);

    //     return {
    //       // title will be filled from embedded SOP JSON, not from the CSV
    //       title: '',
    //       url,
    //       org
    //     };
    //   }).filter(Boolean);
    // }

    // function rowsToObjects(rows) {
    //   const header = rows[0].map(normalizeHeader);
    //   console.log(`header`, header);
    //   const idx = (k) => header.indexOf(normalizeHeader(k));
    //   const has = (k) => idx(k) !== -1;

    //   // only url is required
    //   if (!has('url')) {
    //     throw new Error('Missing required column: url');
    //   }

    //   return rows.slice(1).map(r => {
    //     const url = r[idx('url')] || '';
    //     if (!url) return null;

    //     const org = has('org') ? (r[idx('org')] || '') : '';
    //     console.log(`org`, org);

    //     return {
    //       // title will be filled from embedded SOP JSON, not from the CSV
    //       title: '',
    //       url,
    //       org
    //     };
    //   }).filter(Boolean);
    // }

    // function rowsToObjects(rows) {
    //   const header = rows[0].map(normalizeHeader);
    //   console.log(`header`, header);
    //   const idx = (k) => header.indexOf(normalizeHeader(k));
    //   const has = (k) => idx(k) !== -1;

    //   // only url is required
    //   if (!has('url')) {
    //     throw new Error('Missing required column: url');
    //   }

    //   return rows.slice(1).map(r => {
    //     const url = r[idx('url')] || '';
    //     if (!url) return null;

    //     const org = has('org') ? (r[idx('org')] || '') : '';
    //     const title = has('title') ? (r[idx('title')] || '') : '';

    //     return {
    //       // use CSV title if present, otherwise empty → will trigger JSON fetch
    //       title: title.trim(),
    //       url,
    //       org
    //     };
    //   }).filter(Boolean);
    // }

    function rowsToObjects(rows) {
      const header = rows[0].map(normalizeHeader);
      console.log('header', header);
      const idx = (k) => header.indexOf(normalizeHeader(k));
      const has = (k) => idx(k) !== -1;

      // only url is required
      if (!has('url')) {
        throw new Error('Missing required column: url');
      }

      return rows.slice(1).map(r => {
        const url = r[idx('url')] || '';
        if (!url) return null;

        const org = has('org') ? (r[idx('org')] || '') : '';
        const title = has('title') ? (r[idx('title')] || '') : '';

        return {
          title: title.trim(),  // if empty → will be hydrated
          url,
          org
        };
      }).filter(Boolean);
    }





    // function loadCSV(text) {
    //   try {
    //     const rows = parseCSV(text);
    //     const items = rowsToObjects(rows);
    //     console.log(`items`, items);
    //     // sort stable by system then title
    //     // items.sort((a, b) => (a.system || '').localeCompare(b.system || '') || a.title.localeCompare(b.title));
    //     state.items = items;
    //     render();
    //   } catch (e) {
    //     alert('CSV error: ' + e.message);
    //   }
    // }

    // function loadCSV(text) {
    //   try {
    //     const rows = parseCSV(text);
    //     const items = rowsToObjects(rows);
    //     // sort stable by system then title
    //     items.sort((a, b) => (a.system || '').localeCompare(b.system || '') || a.title.localeCompare(b.title));
    //     state.items = items;
    //     render();
    //     hydrateFromSop(); // NEW: fill title + system from embedded JSON
    //   } catch (e) {
    //     alert('CSV error: ' + e.message);
    //   }
    // }

    // function loadCSV(text) {
    //   state.loadingCsv = true;
    //   render();

    //   try {
    //     const rows = parseCSV(text);
    //     const items = rowsToObjects(rows);
    //     items.sort((a, b) => (a.group || a.system || '').localeCompare(b.group || b.system || '') || (a.title || '').localeCompare(b.title || ''));
    //     state.items = items;
    //     render();
    //     hydrateFromSop && hydrateFromSop(); // keep whatever you already had
    //   } catch (e) {
    //     alert('CSV error: ' + e.message);
    //   } finally {
    //     state.loadingCsv = false;
    //     render();
    //   }
    // }

    // function loadCSV(text) {
    //   state.loadingCsv = true;
    //   state.csvError = null;   // NEW: clear previous error
    //   render();

    //   try {
    //     const rows = parseCSV(text);
    //     const items = rowsToObjects(rows);
    //     // ...
    //     state.items = items;
    //     render();
    //     hydrateFromSop && hydrateFromSop();
    //   } catch (e) {
    //     state.csvError = e && e.message ? e.message : 'Failed to parse CSV'; // NEW
    //     // optional: keep alert if you want
    //     // alert('CSV error: ' + state.csvError);
    //   } finally {
    //     state.loadingCsv = false;
    //     render();
    //   }
    // }


    // function loadCSV(text) {
    //   state.loadingCsv = true;
    //   state.csvError = null;
    //   state.csvWarning = null;   // NEW: reset warning
    //   render();

    //   try {
    //     const rows = parseCSV(text);
    //     const items = rowsToObjects(rows);
    //     console.log(`itemss`, items);

    //     // NEW: detect rows with missing URL (rowsToObjects returns null for them)
    //     const totalDataRows = Math.max(0, rows.length - 1); // exclude header
    //     const missingUrls = Math.max(0, totalDataRows - items.length);
    //     if (missingUrls > 0) {
    //       state.csvWarning = `${missingUrls} row(s) in the CSV are missing a URL and were ignored.`;
    //     }

    //     // items.sort(/* your existing sort here */);
    //     state.items = items;
    //     render();
    //     hydrateFromSop && hydrateFromSop();
    //   } catch (e) {
    //     state.csvError = e && e.message ? e.message : 'Failed to parse CSV';
    //   } finally {
    //     state.loadingCsv = false;
    //     render();
    //   }
    // }

    // function loadCSV(text) {
    //   state.loadingCsv = true;
    //   state.csvError = null;
    //   state.csvWarning = null;   // NEW: reset warning
    //   render();

    //   try {
    //     const rows = parseCSV(text);
    //     const items = rowsToObjects(rows);
    //     console.log(`itemss`, items);

    //     // NEW: detect rows with missing URL (rowsToObjects returns null for them)
    //     const totalDataRows = Math.max(0, rows.length - 1); // exclude header
    //     const missingUrls = Math.max(0, totalDataRows - items.length);
    //     if (missingUrls > 0) {
    //       state.csvWarning = `${missingUrls} row(s) in the CSV are missing a URL and were ignored.`;
    //     }

    //     // items.sort(/* your existing sort here */);
    //     state.items = items;
    //     render();

    //     const needsHydration = items.some(it => !it.title);
    //     if (needsHydration && typeof hydrateFromSop === 'function') {
    //       hydrateFromSop();
    //     }

    //   } catch (e) {
    //     state.csvError = e && e.message ? e.message : 'Failed to parse CSV';
    //   } finally {
    //     state.loadingCsv = false;
    //     render();
    //   }
    // }

    function loadCSV(text) {
      state.loadingCsv = true;
      state.csvError = null;
      state.csvWarning = null;
      render();

      try {
        const rows = parseCSV(text);
        const items = rowsToObjects(rows);
        console.log('items', items);

        // detect rows with missing URL (rowsToObjects returns null for them)
        const totalDataRows = Math.max(0, rows.length - 1); // exclude header
        const missingUrls = Math.max(0, totalDataRows - items.length);
        if (missingUrls > 0) {
          state.csvWarning = `${missingUrls} row(s) in the CSV are missing a URL and were ignored.`;
        }

        // reset hydration status based on CSV title
        for (const it of items) {
          if (it.title && it.title.trim()) {
            it._hydratedStatus = 'ok';      // has title from CSV → no skeleton, no fetch
          } else {
            it._hydratedStatus = undefined; // no title yet → will skeleton + hydrate
          }
        }

        // optional: sorting
        // items.sort((a, b) => (a.org || '').localeCompare(b.org || '') || (a.title || '').localeCompare(b.title || ''));

        state.items = items;
        render();

        const needsHydration = items.some(it => !it.title || !it.title.trim());
        if (needsHydration && typeof hydrateFromSop === 'function') {
          hydrateFromSop();
        }
      } catch (e) {
        state.csvError = e && e.message ? e.message : 'Failed to parse CSV';
      } finally {
        state.loadingCsv = false;
        render();
      }
    }


    // async function hydrateFromSop() {
    //   const items = state.items || [];
    //   if (!items.length) return;

    //   for (const it of items) {
    //     if (!it.url) continue;
    //     if (it._hydrated) continue; // avoid re-fetching on every render

    //     try {
    //       const res = await fetch(it.url);
    //       if (!res.ok) continue;

    //       let htmlText = await res.text();

    //       // Same unescape logic you use in Studio
    //       if (/&lt;html\b/i.test(htmlText) && !/<html\b/i.test(htmlText)) {
    //         htmlText = htmlText
    //           .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
    //           .replace(/&quot;/g, '"').replace(/&#39;/g, "'")
    //           .replace(/&amp;/g, '&');
    //       }

    //       const doc = new DOMParser().parseFromString(htmlText, 'text/html');
    //       let jsonText = '';

    //       const slotPlain = doc.querySelector('script#jsonEmbedded');
    //       if (slotPlain && slotPlain.textContent.trim()) {
    //         jsonText = slotPlain.textContent.trim();
    //       }

    //       if (!jsonText) {
    //         const slotDefault = doc.querySelector('script#default-sop[type="application/json"]');
    //         if (slotDefault && slotDefault.textContent.trim()) {
    //           jsonText = slotDefault.textContent.trim();
    //         }
    //       }

    //       if (!jsonText) {
    //         const anyJson = Array.from(doc.querySelectorAll('script[type="application/json"]'))
    //           .find(s => /\bstarters\b/.test(s.textContent || ''));
    //         if (anyJson && anyJson.textContent.trim()) {
    //           jsonText = anyJson.textContent.trim();
    //         }
    //       }

    //       if (!jsonText) continue;

    //       let parsed;
    //       try {
    //         parsed = JSON.parse(jsonText);
    //       } catch {
    //         continue;
    //       }

    //       // System name = root title in your JSON (e.g. "SYSTEM 1")
    //       const systemName = (typeof parsed.title === 'string' ? parsed.title.trim() : '') || '';

    //       // SOP title = first starter label, fallback to systemName
    //       let sopTitle = '';
    //       if (Array.isArray(parsed.starters) &&
    //         parsed.starters[0] &&
    //         typeof parsed.starters[0].label === 'string') {
    //         sopTitle = parsed.starters[0].label.trim();
    //       }
    //       if (!sopTitle) sopTitle = systemName || '';

    //       if (sopTitle) it.title = sopTitle;
    //       if (systemName) it.system = systemName;   // << fills card with corresponding system name
    //       it._hydrated = true;
    //     } catch (err) {
    //       console.warn('Failed to hydrate SOP for', it.url, err);
    //     }
    //   }

    //   // Re-render once after hydration so cards show correct title + system
    //   render();
    // }


    // async function hydrateFromSop() {
    //   const items = state.items || [];
    //   if (!items.length) return;

    //   for (const it of items) {
    //     if (!it.url) {
    //       it._hydratedStatus = 'failed';
    //       continue;
    //     }

    //     // skip if we already tried before
    //     if (it._hydratedStatus === 'ok' || it._hydratedStatus === 'failed') {
    //       continue;
    //     }

    //     try {
    //       const res = await fetch(it.url);
    //       if (!res.ok) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       let htmlText = await res.text();

    //       // Same unescape logic you use in Studio
    //       if (/&lt;html\b/i.test(htmlText) && !/<html\b/i.test(htmlText)) {
    //         htmlText = htmlText
    //           .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
    //           .replace(/&quot;/g, '"').replace(/&#39;/g, "'")
    //           .replace(/&amp;/g, '&');
    //       }

    //       const doc = new DOMParser().parseFromString(htmlText, 'text/html');
    //       let jsonText = '';

    //       // 1) <script id="jsonEmbedded">
    //       const slotPlain = doc.querySelector('script#jsonEmbedded');
    //       if (slotPlain && slotPlain.textContent.trim()) {
    //         jsonText = slotPlain.textContent.trim();
    //       }

    //       // 2) <script id="default-sop" type="application/json">
    //       if (!jsonText) {
    //         const slotDefault = doc.querySelector('script#default-sop[type="application/json"]');
    //         if (slotDefault && slotDefault.textContent.trim()) {
    //           jsonText = slotDefault.textContent.trim();
    //         }
    //       }

    //       // 3) Any <script type="application/json"> containing "starters"
    //       if (!jsonText) {
    //         const anyJson = Array.from(doc.querySelectorAll('script[type="application/json"]'))
    //           .find(s => /\bstarters\b/.test(s.textContent || ''));
    //         if (anyJson && anyJson.textContent.trim()) {
    //           jsonText = anyJson.textContent.trim();
    //         }
    //       }

    //       // No embedded JSON found at all
    //       if (!jsonText) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       let parsed;
    //       try {
    //         parsed = JSON.parse(jsonText);
    //       } catch {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       // Require starters[] to exist
    //       if (!parsed || !Array.isArray(parsed.starters) || !parsed.starters.length) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       // System name = root title in your JSON (e.g. "SYSTEM 1")
    //       const systemName =
    //         (typeof parsed.title === 'string' ? parsed.title.trim() : '') || '';

    //       // SOP title = first starter label, fallback to systemName
    //       let sopTitle = '';
    //       if (parsed.starters[0] && typeof parsed.starters[0].label === 'string') {
    //         sopTitle = parsed.starters[0].label.trim();
    //       }
    //       if (!sopTitle) sopTitle = systemName || '';

    //       if (!sopTitle && !systemName) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       if (sopTitle) it.title = sopTitle;
    //       if (systemName) it.system = systemName;

    //       it._hydratedStatus = 'ok';
    //     } catch (err) {
    //       console.warn('Failed to hydrate SOP for', it.url, err);
    //       it._hydratedStatus = 'failed';
    //     }
    //   }

    //   // Re-render once after hydration so cards show correct title / system or failure state
    //   render();
    // }

    // async function hydrateFromSop() {
    //   const items = state.items || [];
    //   console.log(`items`, items);
    //   if (!items.length) return;

    //   for (const it of items) {
    //     if (!it.url) {
    //       it._hydratedStatus = 'failed';
    //       continue;
    //     }

    //     // already processed
    //     if (it._hydratedStatus === 'ok' || it._hydratedStatus === 'failed') {
    //       continue;
    //     }

    //     try {
    //       const res = await fetch(it.url);
    //       if (!res.ok) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       let htmlText = await res.text();

    //       // unescape entity-escaped HTML (same logic as Studio)
    //       if (/&lt;html\b/i.test(htmlText) && !/<html\b/i.test(htmlText)) {
    //         htmlText = htmlText
    //           .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
    //           .replace(/&quot;/g, '"').replace(/&#39;/g, "'")
    //           .replace(/&amp;/g, '&');
    //       }

    //       const doc = new DOMParser().parseFromString(htmlText, 'text/html');

    //       // ONLY jsonEmbedded
    //       const slotPlain = doc.querySelector('script#jsonEmbedded');
    //       if (!slotPlain || !slotPlain.textContent.trim()) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       const jsonText = slotPlain.textContent.trim();

    //       let parsed;
    //       try {
    //         parsed = JSON.parse(jsonText);
    //       } catch {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       // title = "title" field from JSON
    //       const jsonTitle = (typeof parsed.title === 'string' ? parsed.title.trim() : '') || 'Unnamed SOP';
    //       if (!jsonTitle) {
    //         it._hydratedStatus = 'failed';
    //         continue;
    //       }

    //       // use JSON title as card title AND system name for now
    //       it.title = jsonTitle;
    //       console.log(`jsonTitle`, it.title);

    //       it._hydratedStatus = 'ok';
    //     } catch (err) {
    //       console.warn('Failed to hydrate SOP for', it.url, err);
    //       it._hydratedStatus = 'failed';
    //     }
    //   }

    //   // re-render so cards move from skeleton → normal or failed state
    //   render();
    // }

    async function hydrateFromSop() {
      const items = state.items || [];
      if (!items.length) return;

      for (const it of items) {
        // if no URL → cannot hydrate
        if (!it.url) {
          it._hydratedStatus = 'failed';
          continue;
        }

        // already processed
        if (it._hydratedStatus === 'ok' || it._hydratedStatus === 'failed') {
          continue;
        }

        // has title from CSV already (defensive, but loadCSV already marks them ok)
        if (it.title && it.title.trim()) {
          it._hydratedStatus = 'ok';
          continue;
        }


        try {
          // const res = await fetch(it.url);
          const res = await fetch(
            it.url + (it.url.includes('?') ? '&' : '?') + '_cb=' + Date.now(),
            { cache: 'no-store' }
          );

          if (!res.ok) {
            it._hydratedStatus = 'failed';
            continue;
          }

          let htmlText = await res.text();

          // unescape entity-escaped HTML (same logic as Studio)
          if (/&lt;html\b/i.test(htmlText) && !/<html\b/i.test(htmlText)) {
            htmlText = htmlText
              .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
              .replace(/&quot;/g, '"').replace(/&#39;/g, "'")
              .replace(/&amp;/g, '&');
          }

          const doc = new DOMParser().parseFromString(htmlText, 'text/html');

          // ONLY jsonEmbedded
          const slotPlain = doc.querySelector('script#jsonEmbedded');
          if (!slotPlain || !slotPlain.textContent.trim()) {
            it._hydratedStatus = 'failed';
            continue;
          }


          const jsonText = slotPlain.textContent.trim();

          let parsed;
          try {
            parsed = JSON.parse(jsonText);
          } catch {
            it._hydratedStatus = 'failed';
            continue;
          }

          // title = "title" field from JSON
          const jsonTitle = (typeof parsed.title === 'string' ? parsed.title.trim() : '') || 'Unnamed SOP';
          // debugger;

          if (!jsonTitle) {
            it._hydratedStatus = 'failed';
            continue;
          }

          // use JSON title only if we still don't have one
          if (!it.title || !it.title.trim()) {
            it.title = jsonTitle;
          }

          console.log('jsonTitle', it.title);
          it._hydratedStatus = 'ok';
        } catch (err) {
          console.warn('Failed to hydrate SOP for', it.url, err);
          it._hydratedStatus = 'failed';
        }
      }

      // re-render so cards move from skeleton → normal/failed state
      render();
    }





    // function loadDefaultCSV() {
    //   if (!DEFAULT_CSV_PATH) return;
    //   fetch(DEFAULT_CSV_PATH)
    //     .then(r => {
    //       if (!r.ok) throw new Error('HTTP ' + r.status);
    //       return r.text();
    //     })
    //     .then(text => loadCSV(text))
    //     .catch(err => {
    //       console.warn('Auto CSV load failed or file missing:', err);
    //       // falls back to manual file select / drag & drop
    //     });
    // }

    // function loadDefaultCSV() {
    //   if (!DEFAULT_CSV_PATH) return;
    //   state.loadingCsv = true;
    //   render();

    //   fetch(DEFAULT_CSV_PATH)
    //     .then(r => {
    //       if (!r.ok) throw new Error('HTTP ' + r.status);
    //       return r.text();
    //     })
    //     .then(text => loadCSV(text))
    //     // .catch(err => {
    //     //   console.warn('Auto CSV load failed:', err);
    //     //   state.loadingCsv = false;
    //     //   render();
    //     // });
    //     .catch(err => {
    //       console.warn('Auto CSV load failed:', err);
    //       state.loadingCsv = false;
    //       state.csvError = `Failed to load ${DEFAULT_CSV_PATH}: ${err && err.message ? err.message : 'File not found'}`;
    //       render();
    //     });

    // }

    function loadDefaultCSV() {
      if (!DEFAULT_CSV_PATH) return;
      state.loadingCsv = true;
      render();

      fetch(DEFAULT_CSV_PATH, { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        })
        .then(text => loadCSV(text))
        .catch(err => {
          console.warn('Auto CSV load failed:', err);
          state.loadingCsv = false;
          state.csvError = `Failed to load ${DEFAULT_CSV_PATH}: ${err && err.message ? err.message : 'File not found'}`;
          render();
        });
    }

    // const searchInput = $('#searchInput');
    // searchInput.addEventListener('input', () => {
    //   const q = (searchInput.value || '').trim();
    //   state.searchQ = q;
    //   if (!q) {
    //     // clear results if query empty
    //     state.searchResults = [];
    //     state.searchLoading = false;
    //     state.searchError = null;
    //     render();
    //     return;
    //   }

    //   debounceSearchAllSops(q);
    // });
    const searchInput = $('#searchInput');
searchInput.addEventListener('input', () => {
  const q = (searchInput.value || '').trim();
  state.searchQ = q;

  if (!q) {
    // NEW: cancel any pending debounced search
    if (searchDebounceTimer) {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = null;
    }

    // NEW: abort any in-flight search
    if (searchController) {
      searchController.abort();
      searchController = null;
    }

    // clear results if query empty
    state.searchResults = [];
    state.searchLoading = false;
    state.searchError = null;
    render();
    return;
  }

  debounceSearchAllSops(q);
});

    let searchDebounceTimer = null;

    function debounceSearchAllSops(q) {
      if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => {
        searchAllSops(q);
      }, 300); // adjust delay if you want faster/slower
    }
    async function loadSopJsonForItem(it, signal) {
      if (it._sopJson) return it._sopJson;

      const href = normalizeHref(it.url);
      const res = await fetch(href, { signal });

      if (!res.ok) return null;

      let htmlText = await res.text();

      // unescape entity-escaped HTML (same logic as Studio)
      if (/&lt;html\b/i.test(htmlText) && !/<html\b/i.test(htmlText)) {
        htmlText = htmlText
          .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
          .replace(/&quot;/g, '"').replace(/&#39;/g, "'")
          .replace(/&amp;/g, '&');
      }

      const doc = new DOMParser().parseFromString(htmlText, 'text/html');
      const slotPlain = doc.querySelector('script#jsonEmbedded');
      if (!slotPlain || !slotPlain.textContent.trim()) return null;

      const jsonText = slotPlain.textContent.trim();
      let parsed;
      try {
        parsed = JSON.parse(jsonText);
      } catch {
        return null;
      }

      if (!parsed || !Array.isArray(parsed.starters) || parsed.starters.length === 0) {
        return null;
      }

      // cashe the loaded SOPS while searching, ones this line is uncommented, it's going to be cashed
      // it._sopJson = parsed;
      return parsed;
    }
    function findSearchPlaceStepId(st, q) {
      q = (q || '').trim().toLowerCase();
      if (!q) return { matched: true, place: null };

      const stepIds = new Set((st.steps || []).map(s => s?.id).filter(Boolean));

      // fields to search
      const ALLOWED_KEYS = new Set([
        'id', 'label', 'summary',
        'title', 'body',
        'placeholder', 'error', 'regex', 'requiredMessage',
        'hint',
      ]);

      // branches to skip entirely
      const SKIP_KEYS = new Set(['img_b64', 'pos', 'next', 'nextId', 'type', 'mode']);

      let matched = false;
      let place = null; // first hit wins

      // Parse rich HTML safely:
      // - include visible text + human-facing attrs
      // - ignore href/src (so data:… base64 doesn’t match)
      function bodySearchHaystack(html) {
        if (!html || typeof html !== 'string') return '';
        const tpl = document.createElement('template');
        tpl.innerHTML = html;

        const parts = [];
        const walker = document.createTreeWalker(
          tpl.content,
          NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT,
          null
        );

        let n;
        while ((n = walker.nextNode())) {
          if (n.nodeType === Node.TEXT_NODE) {
            const t = n.nodeValue;
            if (t && t.trim()) parts.push(t);
          } else if (n.nodeType === Node.ELEMENT_NODE) {
            const el = /** @type {HTMLElement} */(n);
            const title = el.getAttribute?.('title');
            const alt = el.getAttribute?.('alt');
            const aria = el.getAttribute?.('aria-label');
            if (title && title.trim()) parts.push(title);
            if (alt && alt.trim()) parts.push(alt);
            if (aria && aria.trim()) parts.push(aria);
            // intentionally skip href/src/etc. (avoid matching base64/data:)
          }
        }
        return parts.join(' ').trim();
      }

      // Look inside a single embed.html (skip scripts/styles/images + data: urls)
      function embedContainsQuery(html, q) {
        if (!html || !q) return false;
        try {
          const doc = new DOMParser().parseFromString(String(html), 'text/html');

          // strip noisy/non-text nodes
          doc.querySelectorAll('script, style, img, svg, image').forEach(n => n.remove());

          // drop any data: URLs so they don't match
          doc.querySelectorAll('[src],[href]').forEach(el => {
            ['src', 'href'].forEach(a => {
              const v = el.getAttribute(a);
              if (v && /^data:/i.test(v)) el.removeAttribute(a);
            });
          });

          // text content + a few human-facing attrs
          const text = (doc.body?.textContent || '').toLowerCase();
          if (text.includes(q)) return true;

          let found = false;
          doc.querySelectorAll('*').forEach(el => {
            if (found) return;
            for (const a of ['title', 'alt', 'aria-label']) {
              const v = el.getAttribute(a);
              if (v && v.toLowerCase().includes(q)) { found = true; break; }
            }
          });
          return found;
        } catch {
          return false;
        }
      }

      (function walk(node, key, stepCtx) {
        if (matched || node == null) return;

        // entering a step object → set context to that step id
        if (node && typeof node === 'object' && node.id && stepIds.has(node.id)) {
          stepCtx = node.id;
        }

        if (SKIP_KEYS.has(key)) return;

        // NEW: search embeds[] html, but don't recurse into it further
        if (key === 'embeds' && Array.isArray(node)) {
          for (const emb of node) {
            if (emb && typeof emb.html === 'string' && embedContainsQuery(emb.html, q)) {
              matched = true;
              place = stepCtx || 'starter';
              return;
            }
          }
          return;
        }

        if (typeof node === 'string') {
          if (!key || ALLOWED_KEYS.has(key)) {
            let hay = node;
            if (key === 'body') hay = bodySearchHaystack(node); // parse HTML, ignore href/src
            if (hay.toLowerCase().includes(q)) {
              matched = true;
              place = stepCtx || 'starter';
            }
          }
        } else if (Array.isArray(node)) {
          for (const item of node) walk(item, '', stepCtx);
        } else if (typeof node === 'object') {
          for (const k in node) {
            if (SKIP_KEYS.has(k)) continue;
            walk(node[k], k, stepCtx);
          }
        }
      })(st, '', null);

      return { matched, place };
    }

    // async function searchAllSops(q) {
    //   const query = (q || '').trim();
    //   state.searchQ = query;

    //   // cancel previous search
    //   if (searchController) searchController.abort();
    //   searchController = new AbortController();
    //   const { signal } = searchController;
    //   const mySeq = ++searchSeq;

    //   state.searchLoading = true;
    //   state.searchError = null;
    //   state.searchResults = [];
    //   render();

    //   const results = [];

    //   try {
    //     for (const it of state.items) {
    //       if (signal.aborted) return; // cancelled

    //       const sopJson = await loadSopJsonForItem(it, signal);
    //       if (!sopJson) continue;

    //       const starters = Array.isArray(sopJson.starters) ? sopJson.starters : [];
    //       for (const st of starters) {
    //         const { matched, place } = findSearchPlaceStepId(st, query.toLowerCase());
    //         if (!matched) continue;

    //         const stepId = place && place !== 'starter' ? place : null;
    //         const stepsCount = Array.isArray(st.steps) ? st.steps.length : 0;

    //         results.push({
    //           sopUrl: normalizeHref(it.url),
    //           sopTitle: sopJson.title || it.title || '',
    //           org: it.org || '',
    //           starterId: st.id || '',
    //           starterLabel: st.label || '',
    //           stepsCount,
    //           stepId
    //         });
    //       }
    //     }

    //     if (signal.aborted) return;
    //     if (mySeq !== searchSeq) return; // stale result

    //     state.searchResults = results;
    //   } catch (err) {
    //     if (err.name === 'AbortError') return;
    //     state.searchError = 'Search failed';
    //   } finally {
    //     if (mySeq === searchSeq) {
    //       state.searchLoading = false;
    //       render();
    //     }
    //   }
    // }

    async function searchAllSops(q) {
      const query = (q || '').trim();
      state.searchQ = query;

      // cancel previous search
      if (searchController) searchController.abort();
      searchController = new AbortController();
      const { signal } = searchController;
      const mySeq = ++searchSeq;

      state.searchLoading = true;
      state.searchError = null;
      state.searchResults = [];
      render();

      const results = [];

      try {
        for (const it of state.items) {
          if (signal.aborted) return;

          const sopJson = await loadSopJsonForItem(it, signal);
          if (!sopJson) continue;

          const starters = Array.isArray(sopJson.starters) ? sopJson.starters : [];

          for (const st of starters) {
            const { matched, place } = findSearchPlaceStepId(st, query.toLowerCase());
            if (!matched) continue;

            const stepId =
              place && place !== 'starter'
                ? place
                : null;

            const stepsCount =
              typeof countFlowSteps === 'function'
                ? countFlowSteps(st)
                : (st.steps || []).length;

            const placeHtml =
              typeof buildSearchBadge === 'function'
                ? buildSearchBadge(st, query)
                : (place === 'starter' ? 'Found in starter' : 'Found in step');

            results.push({
              sopUrl: normalizeHref(it.url),
              sopTitle: sopJson.title || it.title || '',
              org: it.org || '',
              starterId: st.id || '',
              starterLabel: st.label || '',
              starterSummary: st.summary || '',
              stepsCount,
              stepId,
              placeHtml
            });
          }
        }

        if (signal.aborted || mySeq !== searchSeq) return;

        state.searchResults = results;
      } catch (err) {
        if (err && err.name === 'AbortError') return;
        state.searchError = 'Search failed';
      } finally {
        if (mySeq === searchSeq) {
          state.searchLoading = false;
          render();
        }
      }
    }


    // function render() {
    //   const gb = state.groupBy || '';
    //   const items = state.items

    // function render() {
    //   const gb = state.groupBy || '';
    //   const allItems = state.items;

    //   // NEW: filter by local title/org for the main grid/list
    //   const q = (state.searchQ || '').trim().toLowerCase();
    //   const items = q
    //     ? allItems.filter(it =>
    //       (it.title && it.title.toLowerCase().includes(q)) ||
    //       (it.org && it.org.toLowerCase().includes(q))
    //     )
    //     : allItems;

    //   function render() {
    // const gb = state.groupBy || '';
    // const items = state.items;
    // const shell = document.getElementById('itemsHost'); // main list/cards container
    // const empty = document.getElementById('empty');     // "empty" message

    //   const hasGlobalSearchQuery = (state.searchQ || '').trim().length > 0;



    //     if (state.loadingCsv) {
    //       empty.classList.remove('hidden');
    //       empty.innerHTML = `
    //   <div class="loading-inline">
    //     <span class="spinner" aria-hidden="true"></span>
    //     <span>Loading SOP list from CSV…</span>
    //   </div>
    // `;
    //     } else if (state.csvError) {
    //       empty.classList.remove('hidden');
    //       empty.innerHTML = `
    //   <strong>Could not load CSV.</strong>
    //   <div class="muted">${escapeHTML(state.csvError)}</div>
    // `;
    //     } else {
    //       let html = `
    //   <strong>No SOPs to display.</strong>
    //   <div class="muted">Configure CSV file and name it '${DEFAULT_CSV_PATH}' to see items here.</div>
    // `;

    //       if (state.csvWarning) {
    //         html += `
    //     <div class="muted" style="margin-top:6px;">
    //       ${escapeHTML(state.csvWarning)}
    //     </div>
    //   `;
    //       }

    //       empty.innerHTML = html;
    //       empty.classList.toggle('hidden', items.length !== 0);
    //     }



    //     // grouping
    //     let groups = { '': items };
    //     if (gb) {
    //       groups = {};
    //       for (const it of items) {
    //         const key = (it[gb] || 'Unspecified');
    //         (groups[key] ||= []).push(it);
    //       }
    //     }

    //     // wipe views
    //     viewCards.innerHTML = '';
    //     viewRows.innerHTML = '';

    //     const renderRow = (it) => {
    //       const el = document.createElement('article');
    //       el.className = 'rowitem';

    //       const href = appendSourceAndSop(DEFAULT_SOP_PATH, normalizeHref(it.url));

    //       el.onclick = () => {
    //         if (!href) return;
    //         location.assign(href); // same tab
    //       };

    //       const status = it._hydratedStatus; // undefined | 'ok' | 'failed' (we don't care about failed now)
    //       const isLoading = status === undefined;

    //       if (isLoading) {
    //         el.innerHTML = `
    //     <div class="skeleton skeleton-title"></div>
    //     <div class="skeleton skeleton-line"></div>
    //   `;
    //       } else {
    //         el.innerHTML = `<h3>${escapeHTML(it.title || '')}</h3>
    //     <div class="muted">${escapeHTML(it.org || '')}</div>
    //     <p style="margin:6px 0 0">
    //       <a class="link" href="${href}">Open SOP</a>
    //     </p>`;
    //       }

    //       return el;
    //     };

    //     const renderCard = (it) => {
    //       const el = document.createElement('article');
    //       el.className = 'card';

    //       const href = appendSourceAndSop(DEFAULT_SOP_PATH, normalizeHref(it.url));

    //       el.onclick = () => {
    //         if (!href) return;
    //         location.assign(href); // same tab
    //       };

    //       const status = it._hydratedStatus; // undefined | 'ok' | 'failed' (we don't care about failed now)
    //       const isLoading = status === undefined;

    //       if (isLoading) {
    //         el.innerHTML = `
    //     <div class="skeleton skeleton-title"></div>
    //     <div class="skeleton skeleton-line"></div>
    //     <div class="skeleton skeleton-line skeleton-line-short"></div>
    //   `;
    //       } else {
    //         el.innerHTML = `<h3>${escapeHTML(it.title || '')}</h3>
    //     <div class="muted">${escapeHTML(it.org || '')}</div>
    //     <p style="margin:10px 0 0">
    //       <a class="link" href="${href}">Open SOP</a>
    //     </p>`;
    //       }

    //       return el;
    //     };

    //     const addHeader = (name, parent) => {
    //       const h = document.createElement('p');
    //       h.textContent = name || 'Unspecified';
    //       h.className = 'group-heading';
    //       // h.style.cssText = '';
    //       parent.appendChild(h);
    //     };


    //     const inCards = state.layout === 'cards';
    //     const target = inCards ? viewCards : viewRows;
    //     for (const [gname, arr] of Object.entries(groups)) {
    //       if (gb) { addHeader(gname, target); }
    //       for (const it of arr) {
    //         target.appendChild(inCards ? renderCard(it) : renderRow(it));
    //       }

    //     }
    //     // if (state.items.length === 0) { empty.classList.remove('hidden'); }

    //     if (items.length === 0) { empty.classList.remove('hidden'); }
    //     renderCardSpotlight();
    //     renderGlobalSearchResults();
    //   }

    function render() {
      const gb = state.groupBy || '';
      const items = state.items || [];
      const shell = document.getElementById('itemsHost'); // main list/cards container (not used directly here)
      const empty = document.getElementById('empty');     // "empty" message

      const hasGlobalSearchQuery = (state.searchQ || '').trim().length > 0;

      // ----- EMPTY / STATUS AREA -----
      if (state.loadingCsv) {
        empty.classList.remove('hidden');
        empty.innerHTML = `
      <div class="loading-inline">
        <span class="spinner" aria-hidden="true"></span>
        <span>Loading SOP list</span>
      </div>
    `;
      } else if (state.csvError) {
        empty.classList.remove('hidden');
        empty.innerHTML = `
      <strong>Could not load CSV.</strong>
      <div class="muted">${escapeHTML(state.csvError)}</div>
    `;
      } else {
        let html = `
      <strong>No SOPs to display.</strong>
      <div class="muted">Configure CSV file and name it '${DEFAULT_CSV_PATH}' to see items here.</div>
    `;

        if (state.csvWarning) {
          html += `
        <div class="muted" style="margin-top:6px;">
          ${escapeHTML(state.csvWarning)}
        </div>
      `;
        }

        empty.innerHTML = html;
        // show empty only when there are no items (and no loading/error)
        if (items.length === 0) {
          empty.classList.remove('hidden');
        } else {
          empty.classList.add('hidden');
        }
      }

      // ----- GROUPING -----
      let groups = { '': items };
      if (gb) {
        groups = {};
        for (const it of items) {
          const key = (it[gb] || 'Unspecified');
          (groups[key] ||= []).push(it);
        }
      }

      // ----- WIPE VIEWS -----
      viewCards.innerHTML = '';
      viewRows.innerHTML = '';

      const renderRow = (it) => {
        const el = document.createElement('article');
        el.className = 'rowitem';

        const href = appendSourceAndSop(DEFAULT_SOP_PATH, normalizeHref(it.url));

        el.onclick = () => {
          if (!href) return;
          location.assign(href); // same tab
        };

        const status = it._hydratedStatus; // undefined | 'ok' | 'failed' (we don't care about failed now)
        const isLoading = status === undefined;

        if (isLoading) {
          el.innerHTML = `
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-line"></div>
      `;
        } else {
          el.innerHTML = `<h3>${escapeHTML(it.title || '')}</h3>
        <div class="muted">${escapeHTML(it.org || '')}</div>
        <p style="margin:6px 0 0">
          <a class="link" href="${href}">Open SOP</a>
        </p>`;
        }

        return el;
      };

      const renderCard = (it) => {
        const el = document.createElement('article');
        el.className = 'card';

        const href = appendSourceAndSop(DEFAULT_SOP_PATH, normalizeHref(it.url));

        el.onclick = () => {
          if (!href) return;
          location.assign(href); // same tab
        };

        const status = it._hydratedStatus; // undefined | 'ok' | 'failed' (we don't care about failed now)
        const isLoading = status === undefined;

        if (isLoading) {
          el.innerHTML = `
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line skeleton-line-short"></div>
      `;
        } else {
          el.innerHTML = `<h3>${escapeHTML(it.title || '')}</h3>
        <div class="muted">${escapeHTML(it.org || '')}</div>
        <p style="margin:10px 0 0">
          <a class="link" href="${href}">Open SOP</a>
        </p>`;
        }

        return el;
      };

      const addHeader = (name, parent) => {
        const h = document.createElement('p');
        h.textContent = name || 'Unspecified';
        h.className = 'group-heading';
        parent.appendChild(h);
      };

      const inCards = state.layout === 'cards';
      const target = inCards ? viewCards : viewRows;

      // ----- MAIN LIST RENDERING -----
      if (!hasGlobalSearchQuery) {
        // normal mode: show grouped SOP cards/rows
        for (const [gname, arr] of Object.entries(groups)) {
          if (gb) { addHeader(gname, target); }
          for (const it of arr) {
            target.appendChild(inCards ? renderCard(it) : renderRow(it));
          }
        }
        // empty element visibility already handled above
      } else {
        // search mode: hide empty completely while searching
        empty.classList.add('hidden');
        // no cards/rows appended here
      }

      renderCardSpotlight();
      renderGlobalSearchResults();
    }

    function renderSearchResultCard(hit) {
      // adapt these property names if your search result object is different
      const sopTitle = hit.sopTitle || '';
      const starterLabel = hit.starterLabel || sopTitle || 'Untitled';
      const starterSummary = hit.starterSummary || '';
      const stepsCount =
        typeof hit.stepsCount === 'number'
          ? hit.stepsCount
          : (hit.steps || 0);

      // where the match was found – tweak if you already compute this elsewhere
      const placeLabel =
        hit.placeLabel ||
        (hit.place === 'starter'
          ? 'Found in starter'
          : 'Found in step');

      const sopUrl = hit.sopUrl || '';
      const starterId = hit.starterId || '';
      const stepId = hit.stepId || '';

      return `
    <div class="starter-dual">
      <button
        class="card search-result-card"
        data-sop-url="${escapeHTML(sopUrl)}"
        data-starter-id="${escapeHTML(starterId)}"
        data-step-id="${escapeHTML(stepId)}"
      >
        <h3>${escapeHTML(starterLabel)}</h3>
        ${starterSummary ? `<p>${escapeHTML(starterSummary)}</p>` : ``}

        <div class="card__actions">
          <div class="pill">
            <span>Steps</span>
            <strong>${stepsCount}</strong>
          </div>

          <p class="search-place">${escapeHTML(placeLabel)}</p>
        </div>
      </button>
    </div>
  `;
    }


    function renderCardSpotlight() {

      const elements = document.querySelectorAll('.card, .rowitem');
      if (!elements.length) return;

      elements.forEach((element) => {
        let spotX = 50;
        let spotY = 50;
        let targetX = 50;
        let targetY = 50;
        let rafId = null;
        let leaveTimeout = null;

        const ease = 0.18;   // follow speed
        const lingerMs = 180; // how long to stay after leaving

        function applySpot() {
          element.style.setProperty('--spot-x', spotX + '%');
          element.style.setProperty('--spot-y', spotY + '%');
        }

        function animate() {
          const dx = targetX - spotX;
          const dy = targetY - spotY;

          if (Math.abs(dx) < 0.1 && Math.abs(dy) < 0.1) {
            spotX = targetX;
            spotY = targetY;
            applySpot();
            rafId = null;
            return;
          }

          spotX += dx * ease;
          spotY += dy * ease;
          applySpot();
          rafId = requestAnimationFrame(animate);
        }

        function startFollow(e, isEnter) {
          const rect = element.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;

          targetX = x;
          targetY = y;

          // on first enter: jump spotlight directly under cursor
          if (isEnter) {
            spotX = x;
            spotY = y;
            applySpot();
          }

          // show the halo
          element.style.setProperty('--spot-opacity', '1');

          if (leaveTimeout !== null) {
            clearTimeout(leaveTimeout);
            leaveTimeout = null;
          }

          if (rafId === null) {
            rafId = requestAnimationFrame(animate);
          }
        }

        element.addEventListener('mouseenter', (e) => {
          startFollow(e, true);
        });

        element.addEventListener('mousemove', (e) => {
          startFollow(e, false);
        });

        element.addEventListener('mouseleave', () => {
          if (leaveTimeout !== null) {
            clearTimeout(leaveTimeout);
          }

          // stay a bit, then fade + drift back to center
          leaveTimeout = setTimeout(() => {
            element.style.setProperty('--spot-opacity', '0'); // fades via CSS
            targetX = 50;
            targetY = 50;
            if (rafId === null) {
              rafId = requestAnimationFrame(animate);
            }
          }, lingerMs);
        });
      });
    }

    // function renderGlobalSearchResults() {
    //   const section = $('#globalSearchSection');
    //   const statusEl = $('#globalSearchStatus');
    //   const listEl = $('#globalSearchResults');

    //   if (!section || !statusEl || !listEl) return;

    //   const q = (state.searchQ || '').trim();
    //   const loading = state.searchLoading;
    //   const err = state.searchError;
    //   const results = state.searchResults || [];

    //   if (!q) {
    //     section.style.display = 'none';
    //     return;
    //   }

    //   section.style.display = 'block';
    //   listEl.innerHTML = '';

    //   if (loading) {
    //     statusEl.textContent = `Searching “${q}”…`;
    //   } else if (err) {
    //     statusEl.textContent = err;
    //   } else if (!results.length) {
    //     statusEl.textContent = `No results for “${q}”.`;
    //   } else {
    //     statusEl.textContent = `Found ${results.length} starter(s) for “${q}”.`;
    //   }

    //   if (!results.length) return;

    //   for (const r of results) {
    //     const href = buildSearchHitHref(r);

    //     const el = document.createElement('article');
    //     el.className = 'rowitem';
    //     el.onclick = () => {
    //       if (!href) return;
    //       location.assign(href);
    //     };

    //     el.innerHTML = `
    //   <h3>${escapeHTML(r.starterLabel || '(no label)')}</h3>
    //   <div class="muted">
    //     ${escapeHTML(r.sopTitle || '')}
    //     ${r.org ? ' · ' + escapeHTML(r.org) : ''}
    //   </div>
    //   <div class="muted" style="font-size:12px; margin-top:4px;">
    //     Starter ID: ${escapeHTML(r.starterId || '')}
    //     ${r.stepId ? ' · Step ID: ' + escapeHTML(r.stepId) : ''}
    //     · Steps: ${r.stepsCount}
    //   </div>
    //   <p style="margin:6px 0 0">
    //     <a class="link" href="${href}">Open here</a>
    //   </p>
    // `;

    //     listEl.appendChild(el);
    //   }
    // }

    // function renderGlobalSearchResults() {
    //   const host = document.getElementById('globalSearchResults');
    //   if (!host) return;

    //   const q = (state.searchQ || '').trim();
    //   // if your hits array has a different name, change here:
    //   const hits = Array.isArray(state.searchResults) ? state.searchResults : [];

    //   // no query or no hits → hide everything
    //   if (!q || !hits.length) {
    //     host.innerHTML = '';
    //     host.classList.add('hidden');
    //     return;
    //   }

    //   host.classList.remove('hidden');

    //   host.innerHTML = hits
    //     .map(hit => renderSearchResultCard(hit))
    //     .join('');
    // }

    // function renderGlobalSearchResults() {
    //   const section = document.getElementById('globalSearchSection');
    //   const statusEl = document.getElementById('globalSearchStatus');
    //   const host = document.getElementById('globalSearchResults');
    //   if (!section || !statusEl || !host) return;

    //   const q = (state.searchQ || '').trim();
    //   const loading = !!state.searchLoading;
    //   const err = state.searchError;
    //   const hits = Array.isArray(state.searchResults) ? state.searchResults : [];

    //   if (!q) {
    //     section.style.display = 'none';
    //     host.innerHTML = '';
    //     return;
    //   }

    //   section.style.display = 'block';

    //   if (loading) {
    //     statusEl.textContent = `Searching “${q}”…`;
    //   } else if (err) {
    //     statusEl.textContent = err;
    //   } else if (!hits.length) {
    //     statusEl.textContent = `No results for “${q}”.`;
    //   } else {
    //     statusEl.textContent = `Found ${hits.length} starter(s) for “${q}”.`;
    //   }

    //   host.innerHTML = '';

    //   if (!hits.length || loading || err) return;

    //   for (const hit of hits) {
    //     const href = buildSearchHitHref(hit);

    //     const wrapper = document.createElement('div');
    //     wrapper.className = 'starter-dual';

    //     const btn = document.createElement('button');
    //     btn.className = 'card';
    //     btn.type = 'button';

    //     btn.innerHTML = `
    //   <h3>${escapeHTML(hit.starterLabel || hit.sopTitle || '(no label)')}</h3>
    //   ${hit.starterSummary ? `<p>${escapeHTML(hit.starterSummary)}</p>` : ``}
    //   <div class="card__actions">
    //     <div class="pill">
    //       <span>Steps</span>
    //       <strong>${hit.stepsCount ?? 0}</strong>
    //     </div>
    //     <p class="search-place">${hit.placeHtml || ''}</p>
    //   </div>
    // `;

    //     btn.onclick = () => {
    //       if (!href) return;
    //       location.assign(href);
    //     };

    //     wrapper.appendChild(btn);
    //     host.appendChild(wrapper);
    //   }
    //   renderCardSpotlight();
    // }

    // function renderGlobalSearchResults() {
    //   const section = document.getElementById('globalSearchSection');
    //   const statusEl = document.getElementById('globalSearchStatus');
    //   const host = document.getElementById('globalSearchResults');
    //   if (!section || !statusEl || !host) return;

    //   const q = (state.searchQ || '').trim();
    //   const loading = !!state.searchLoading;
    //   const err = state.searchError;
    //   const hits = Array.isArray(state.searchResults) ? state.searchResults : [];

    //   // no query → hide whole section
    //   if (!q) {
    //     section.style.display = 'none';
    //     host.innerHTML = '';
    //     return;
    //   }

    //   section.style.display = 'block';

    //   if (loading) {
    //     statusEl.textContent = `Searching “${q}”…`;
    //   } else if (err) {
    //     statusEl.textContent = err;
    //   } else if (!hits.length) {
    //     statusEl.textContent = `No results for “${q}”.`;
    //   } 
    //   // else {
    //   //   statusEl.textContent = `Found ${hits.length} starter(s) for “${q}”.`;
    //   // }

    //   host.innerHTML = '';

    //   // nothing concrete to render yet
    //   if (!hits.length || loading || err) return;

    //   // helper: create one card element for a search hit
    //   function createHitCard(hit) {
    //     const href = buildSearchHitHref(hit);

    //     const wrapper = document.createElement('div');
    //     wrapper.className = 'starter-dual';

    //     const btn = document.createElement('button');
    //     btn.className = 'card';
    //     btn.type = 'button';

    //     btn.innerHTML = `
    //   <h3>${escapeHTML(hit.starterLabel || hit.sopTitle || '(no label)')}</h3>
    //   ${hit.starterSummary ? `<p>${escapeHTML(hit.starterSummary)}</p>` : ``}
    //   <div class="card__actions">
    //     <div class="pill">
    //       <span>Steps</span>
    //       <strong>${hit.stepsCount ?? 0}</strong>
    //     </div>
    //     <p class="search-place">${hit.placeHtml || ''}</p>
    //   </div>
    // `;

    //     btn.onclick = () => {
    //       if (!href) return;
    //       location.assign(href);
    //     };

    //     wrapper.appendChild(btn);
    //     return wrapper;
    //   }

    //   const groupByOrg = state.groupBy === 'org';

    //   if (groupByOrg) {
    //     // group search hits by org (like main SOP list)
    //     const groups = {};
    //     for (const hit of hits) {
    //       const key = hit.org || 'Unspecified';
    //       (groups[key] ||= []).push(hit);
    //     }

    //     for (const [orgName, arr] of Object.entries(groups)) {
    //       const header = document.createElement('p');
    //       header.className = 'group-heading';
    //       header.textContent = orgName || 'Unspecified';
    //       host.appendChild(header);

    //       for (const hit of arr) {
    //         host.appendChild(createHitCard(hit));
    //       }
    //     }
    //   } else {
    //     // flat list of hits (no grouping)
    //     for (const hit of hits) {
    //       host.appendChild(createHitCard(hit));
    //     }
    //   }

    //   renderCardSpotlight();
    // }

    // function renderGlobalSearchResults() {
    //   const section = document.getElementById('globalSearchSection');
    //   const statusEl = document.getElementById('globalSearchStatus');
    //   const host = document.getElementById('globalSearchResults');

    //   if (!section || !statusEl || !host) return;

    //   const q = (state.searchQ || '').trim();
    //   const loading = !!state.searchLoading;
    //   const err = state.searchError;
    //   const hits = Array.isArray(state.searchResults) ? state.searchResults : [];

    //   // no query → hide whole section
    //   if (!q) {
    //     section.style.display = 'none';
    //     statusEl.textContent = '';
    //     host.innerHTML = '';
    //     return;
    //   }

    //   section.style.display = 'block';

    //   // loading: show spinner block and stop
    //   if (loading) {
    //     statusEl.textContent = '';
    //     host.innerHTML = `
    //   <div class="loading-inline">
    //     <span class="spinner" aria-hidden="true"></span>
    //     <span>Loading search results…</span>
    //   </div>
    // `;
    //     return;
    //   }

    //   // error
    //   if (err) {
    //     statusEl.textContent = err;
    //     host.innerHTML = '';
    //     return;
    //   }

    //   // no hits
    //   if (!hits.length) {
    //     statusEl.textContent = `No results for “${q}”.`;
    //     host.innerHTML = '';
    //     return;
    //   }

    //   // we have hits
    //   statusEl.textContent = `Found ${hits.length} starter(s) for “${q}”.`;
    //   host.innerHTML = '';

    //   function createHitCard(hit) {
    //     const href = buildSearchHitHref(hit);

    //     const wrapper = document.createElement('div');
    //     wrapper.className = 'starter-dual';

    //     const btn = document.createElement('button');
    //     btn.className = 'card';
    //     btn.type = 'button';

    //     btn.innerHTML = `
    //   <h3>${escapeHTML(hit.starterLabel || hit.sopTitle || '(no label)')}</h3>
    //   ${hit.starterSummary ? `<p>${escapeHTML(hit.starterSummary)}</p>` : ``}
    //   <div class="card__actions">
    //     <div class="pill">
    //       <span>Steps</span>
    //       <strong>${hit.stepsCount ?? 0}</strong>
    //     </div>
    //     <p class="search-place">${hit.placeHtml || ''}</p>
    //   </div>
    // `;

    //     btn.onclick = () => {
    //       if (!href) return;
    //       location.assign(href);
    //     };

    //     wrapper.appendChild(btn);
    //     return wrapper;
    //   }

    //   const groupByOrg = state.groupBy === 'org';

    //   if (groupByOrg) {
    //     const groups = {};
    //     for (const hit of hits) {
    //       const key = hit.org || 'Unspecified';
    //       (groups[key] ||= []).push(hit);
    //     }

    //     for (const [orgName, arr] of Object.entries(groups)) {
    //       const header = document.createElement('p');
    //       header.className = 'group-heading';
    //       header.textContent = orgName || 'Unspecified';
    //       host.appendChild(header);

    //       for (const hit of arr) {
    //         host.appendChild(createHitCard(hit));
    //       }
    //     }
    //   } else {
    //     for (const hit of hits) {
    //       host.appendChild(createHitCard(hit));
    //     }
    //   }

    //   renderCardSpotlight();
    // }

    function renderGlobalSearchResults() {
      const section = document.getElementById('globalSearchSection');
      const statusEl = document.getElementById('globalSearchStatus');
      const host = document.getElementById('globalSearchResults');
      const empty = document.getElementById('empty');
      if (!section || !statusEl || !host || !empty) return;

      const q = (state.searchQ || '').trim();
      const loading = !!state.searchLoading;
      const err = state.searchError;
      const hits = Array.isArray(state.searchResults) ? state.searchResults : [];

      // no query → hide whole search section, let render() manage `empty`
      if (!q) {
        section.style.display = 'none';
        statusEl.textContent = '';
        host.innerHTML = '';
        return;
      }

      section.style.display = 'block';

      // --- LOADING: use `empty` wrapper with spinner ---
      if (loading) {
        statusEl.textContent = '';
        host.innerHTML = '';

        empty.classList.remove('hidden');
        empty.innerHTML = `
      <div class="loading-inline">
        <span class="spinner" aria-hidden="true"></span>
        <span>Loading search results…</span>
      </div>
    `;
        return;
      }

      // from here, search is not loading → hide `empty` (search takes over)
      empty.classList.add('hidden');

      // --- ERROR ---
      if (err) {
        statusEl.textContent = err;
        host.innerHTML = '';
        return;
      }

      // --- NO HITS ---
      if (!hits.length) {
        statusEl.textContent = `No results for “${q}”.`;
        host.innerHTML = '';
        return;
      }

      // --- HAVE HITS ---
      statusEl.textContent = `Found ${hits.length} starter(s) for “${q}”.`;
      host.innerHTML = '';

      function createHitCard(hit) {
        const href = buildSearchHitHref(hit);

        const wrapper = document.createElement('div');
        wrapper.className = 'starter-dual';

        const btn = document.createElement('button');
        btn.className = 'card';
        btn.type = 'button';

        btn.innerHTML = `
      <h3>${escapeHTML(hit.starterLabel || hit.sopTitle || '(no label)')}</h3>
      ${hit.starterSummary ? `<p>${escapeHTML(hit.starterSummary)}</p>` : ``}
      <div class="card__actions">
        <div class="pill">
          <span>Steps</span>
          <strong>${hit.stepsCount ?? 0}</strong>
        </div>
        <p class="search-place">${hit.placeHtml || ''}</p>
      </div>
    `;

        btn.onclick = () => {
          if (!href) return;
          location.assign(href);
        };

        wrapper.appendChild(btn);
        return wrapper;
      }

      const groupByOrg = state.groupBy === 'org';

      if (groupByOrg) {
        const groups = {};
        for (const hit of hits) {
          const key = hit.org || 'Unspecified';
          (groups[key] ||= []).push(hit);
        }

        for (const [orgName, arr] of Object.entries(groups)) {
          const header = document.createElement('p');
          header.className = 'group-heading';
          header.textContent = orgName || 'Unspecified';
          host.appendChild(header);

          for (const hit of arr) {
            host.appendChild(createHitCard(hit));
          }
        }
      } else {
        for (const hit of hits) {
          host.appendChild(createHitCard(hit));
        }
      }
    }

    function buildSearchHitHref(hit) {
      const base = appendSourceAndSop(DEFAULT_SOP_PATH, hit.sopUrl);
      try {
        const u = new URL(base, location.href);
        if (hit.starterId) u.searchParams.set('starter_id', hit.starterId);
        if (hit.stepId) u.searchParams.set('step_id', hit.stepId);
        return u.toString();
      } catch {
        return base;
      }
    }



    function normalizeHref(url) {
      if (!url) return '#';
      // already absolute (http/https)
      if (/^https?:\/\//i.test(url)) return url;
      // looks like bare domain, assume https
      if (/^www\./i.test(url)) return 'https://' + url;
      // otherwise treat as relative SOP path
      return url;
    }

    // function appendSource(url) {
    //   try {
    //     const u = new URL(url);
    //     const src = encodeURIComponent(location.href);
    //     u.searchParams.set('source', src);
    //     return u.toString();
    //   } catch {
    //     return url;
    //   }
    // }

    // function appendSourceAndSop(url, sopUrl) {
    //   try {
    //     const u = new URL(url);
    //     const src = encodeURIComponent(location.href);
    //     const sop = encodeURIComponent(sopUrl);
    //     u.searchParams.set('source', src);
    //     u.searchParams.set('sop_url', sop);
    //     return u.toString();
    //   } catch {
    //     return url;
    //   }
    // }

    function appendSource(url) {
      try {
        const u = new URL(url, location.href); // use current page as base
        u.searchParams.set('source', location.href); // no manual encode
        return u.toString();
      } catch {
        return url;
      }
    }

    function appendSopUrl(url, sopUrl) {
      try {
        const u = new URL(url, location.href);
        const resolvedSopUrl = new URL(sopUrl, location.href).href; // make it absolute
        u.searchParams.set('sop_url', resolvedSopUrl);
        return u.toString();
      } catch {
        return url;
      }
    }

    function appendSourceAndSop(url, sopUrl) {
      try {
        const u = new URL(url, location.href);
        const resolvedSopUrl = new URL(sopUrl, location.href).href;
        u.searchParams.set('source', location.href);
        u.searchParams.set('sop_url', resolvedSopUrl);
        return u.toString();
      } catch {
        return url;
      }
    }



    function escapeHTML(s) { return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[m])); }

    // File select
    // fileInput.addEventListener('change', (e) => {
    //   const f = e.target.files?.[0]; if (!f) return; readFile(f);
    // });

    // Drag & drop
    // ;['dragenter', 'dragover'].forEach(ev => drop.addEventListener(ev, (e) => { e.preventDefault(); drop.classList.add('drag'); }));
    // ;['dragleave', 'drop'].forEach(ev => drop.addEventListener(ev, (e) => { e.preventDefault(); drop.classList.remove('drag'); }));
    // drop.addEventListener('drop', (e) => { const f = e.dataTransfer.files?.[0]; if (f) readFile(f); });

    function readFile(file) {
      const r = new FileReader();
      r.onload = () => loadCSV(String(r.result || ''));
      r.readAsText(file);
    }

    // Clear data
    // $('#btnClear').onclick = () => { state.items = []; render(); };

    // Search & group handlers
    // searchInput.addEventListener('input', render);
    // groupBy.addEventListener('change', render);

    // init
    setLayout(state.layout);
    loadDefaultCSV(); // tries to auto-load ./sop-hub-data.csv
    render();

  </script>
</body>

</html>