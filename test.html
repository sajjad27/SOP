<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pure JS Rich Text</title>
<style>
  :root { --bg:#f7f9fc; --fg:#0b1220; --card:#fff; --line:#e5e7eb; --accent:#2563eb; }
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:0 16px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border:1px solid var(--line);
           border-bottom:none;background:#fff;border-radius:10px 10px 0 0}
  .toolbar button, .toolbar select {padding:8px 10px;border:1px solid var(--line);background:#fff;
           border-radius:8px;cursor:pointer}
  .toolbar button:hover, .toolbar select:hover{border-color:#cbd5e1}
  .editor{min-height:320px;padding:16px;border:1px solid var(--line);border-radius:0 0 10px 10px;
          background:var(--card);outline:none}
  .status{margin-top:8px;font-size:12px;color:#64748b}
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar" onmousedown="event.preventDefault()">
      <select id="block" onchange="cmd('formatBlock', this.value)">
        <option value="P">Paragraph</option>
        <option value="H1">H1</option>
        <option value="H2">H2</option>
        <option value="H3">H3</option>
        <option value="BLOCKQUOTE">Quote</option>
      </select>
      <button onclick="cmd('bold')"><b>B</b></button>
      <button onclick="cmd('italic')"><i>I</i></button>
      <button onclick="cmd('underline')"><u>U</u></button>
      <button onclick="cmd('insertUnorderedList')">• List</button>
      <button onclick="cmd('insertOrderedList')">1. List</button>
      <button onclick="makeLink()">Link</button>
      <button onclick="cmd('removeFormat')">Clear format</button>
      <button onclick="cmd('undo')">Undo</button>
      <button onclick="cmd('redo')">Redo</button>
      <button onclick="cleanHtml()">Clean HTML</button>
      <button onclick="dump()">Show HTML</button>
    </div>

    <div id="editor" class="editor" contenteditable="true">
      <h2>Start typing…</h2>
      <p>Select some text and try the toolbar. You can paste too.</p>
    </div>

    <div id="status" class="status"></div>
  </div>

<script>
  // Minimal helper to run rich-text commands
  function cmd(name, value=null){ document.execCommand(name, false, value); editor.focus(); }

  function makeLink(){
    const url = prompt('URL (e.g., https://example.com):');
    if(!url) return;
    cmd('createLink', url);
  }

  // Very small sanitizer for common paste clutter (keeps basic tags only)
  function cleanHtml(){
    const allowed = new Set(['B','I','U','A','P','H1','H2','H3','UL','OL','LI','BLOCKQUOTE','BR','STRONG','EM','SPAN','DIV']);
    const tmp = document.createElement('div'); tmp.innerHTML = editor.innerHTML;
    (function walk(node){
      for(let i=node.childNodes.length-1;i>=0;i--){
        const c=node.childNodes[i];
        if(c.nodeType===1){
          if(!allowed.has(c.tagName)){
            // unwrap: replace the element with its children
            while(c.firstChild) node.insertBefore(c.firstChild, c);
            node.removeChild(c);
          }else{
            // strip event attrs and styles
            [...c.attributes].forEach(a=>{
              const n=a.name.toLowerCase();
              if(n.startsWith('on') || n==='style') c.removeAttribute(a.name);
              if(c.tagName==='A' && n==='href' && !/^https?:\/\//i.test(a.value))
                c.setAttribute('href', 'https://' + a.value.replace(/^\/*/,''));
              if(c.tagName!=='A' && n==='href') c.removeAttribute('href');
            });
            walk(c);
          }
        }
      }
    })(tmp);
    editor.innerHTML = tmp.innerHTML;
    setStatus('HTML cleaned');
  }

  function dump(){
    const html = editor.innerHTML.trim();
    const w = window.open('', '_blank', 'width=800,height=600');
    w.document.write('<pre style="white-space:pre-wrap;font:13px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">'
      + escapeHtml(html) + '</pre>');
    w.document.close();
  }

  function setStatus(msg){ status.textContent = msg; setTimeout(()=>status.textContent='',2000); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Normalize block dropdown on selection change
  document.addEventListener('selectionchange', ()=>{
    const selBlock = document.queryCommandValue('formatBlock') || 'P';
    const opt = selBlock.replace(/[<>]/g,'').toUpperCase();
    block.value = ['H1','H2','H3','BLOCKQUOTE','P'].includes(opt) ? opt : 'P';
  });

  // Clean on paste to reduce messy HTML from Word/Docs (keeps plaintext with line breaks)
  editor.addEventListener('paste', (e)=>{
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text');
    document.execCommand('insertText', false, text);
  });

  const editor = document.getElementById('editor');
  const status = document.getElementById('status');
</script>
</body>
</html>
